<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="In this article, I will extend topic by bug bounty tips for weaknesses in authentication/authorization implementation in relation to nginx’s $request_uri variable. APIs This vulnerability is for APIs. Best scenario are microservice deployed to Kubernetes and exposed by ingress controller."><title>Bug bounty tips for nginx $request_uri path traversal bypass</title><link rel=canonical href=https://xvnpw.github.io/posts/bug_bounty_tips_for_nginx_request_uri_path_traversal_bypass/><link rel=stylesheet href=/scss/style.min.450926226e724574a6b936335ea06111f8aeb253d932c86cb2cc807341cd2889.css><meta property="og:title" content="Bug bounty tips for nginx $request_uri path traversal bypass"><meta property="og:description" content="In this article, I will extend topic by bug bounty tips for weaknesses in authentication/authorization implementation in relation to nginx’s $request_uri variable. APIs This vulnerability is for APIs. Best scenario are microservice deployed to Kubernetes and exposed by ingress controller."><meta property="og:url" content="https://xvnpw.github.io/posts/bug_bounty_tips_for_nginx_request_uri_path_traversal_bypass/"><meta property="og:site_name" content="xvnpw personal blog"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="kubernetes"><meta property="article:tag" content="nginx"><meta property="article:tag" content="kong"><meta property="article:tag" content="F5"><meta property="article:tag" content="apisix"><meta property="article:tag" content="path-traversal"><meta property="article:tag" content="bugbounty"><meta property="article:published_time" content="2021-11-27T22:59:05+01:00"><meta property="article:modified_time" content="2021-11-27T22:59:05+01:00"><meta name=twitter:site content="@xvnpw"><meta name=twitter:creator content="@xvnpw"><meta name=twitter:title content="Bug bounty tips for nginx $request_uri path traversal bypass"><meta name=twitter:description content="In this article, I will extend topic by bug bounty tips for weaknesses in authentication/authorization implementation in relation to nginx’s $request_uri variable. APIs This vulnerability is for APIs. Best scenario are microservice deployed to Kubernetes and exposed by ingress controller."><script async src="https://www.googletagmanager.com/gtag/js?id=G-YHETMXZXMZ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YHETMXZXMZ",{anonymize_ip:!1})}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=https://user-images.githubusercontent.com/17719543/142780058-1ede8ab3-567f-471f-b802-788efca3684f.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>xvnpw personal blog</a></h1><h2 class=site-description>hacking, bug bounty, appsec</h2></div></header><ol class=social-menu><li><a href=https://github.com/xvnpw target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/xvnpw target=_blank title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/posts/bug_bounty_tips_for_nginx_request_uri_path_traversal_bypass/>Bug bounty tips for nginx $request_uri path traversal bypass</a></h2><h3 class=article-subtitle>In this article, I will extend topic by bug bounty tips for weaknesses in authentication/authorization implementation in relation to nginx’s $request_uri variable. APIs This vulnerability is for APIs. Best scenario are microservice deployed to Kubernetes and exposed by ingress controller.</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Nov 27, 2021</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>4 minute read</time></div></footer></div></header><section class=article-content><figure class=image-center><img src=https://user-images.githubusercontent.com/17719543/139592951-0fafc921-437e-4bb7-b0ee-199dd72b36c3.png></figure><p>In this article, I will extend topic by bug bounty tips for weaknesses in authentication/authorization implementation in relation to nginx&rsquo;s <code>$request_uri</code> variable.</p><h2 id=apis>APIs</h2><p>This vulnerability is for APIs. Best scenario are <strong>microservice</strong> deployed to Kubernetes and exposed by ingress controller.</p><h2 id=using-paths>Using paths</h2><p>API that you are playing with, need to use paths to address services, e.g.:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>OK!
</span></span><span class=line><span class=cl>https://api.example.com/user-service
</span></span><span class=line><span class=cl>https://api.example.com/customer-service
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>NOT OK!
</span></span><span class=line><span class=cl>https://user.example.com/
</span></span><span class=line><span class=cl>https://customer.example.com/
</span></span></code></pre></td></tr></table></div></div><p>First set of URLs is good for exploitation, as you can try sending request with <code>https://api.example.com/user-service/..%2F/customer-service/endpoint1</code></p><h2 id=using-nginx-based-ingress-controller>Using nginx based ingress controller</h2><p>In this point we have having two condition, using Kubernetes and using nginx based ingress controller, e.g.: kong, Apache APISIX, F5 NGINX. </p><p>Kubernetes is used in many organizations right now. If you see that API consists of multiply services, you can safely bet on Kubernetes as orchestration. </p><p>To verify if specific ingress is in place you can try to get error message, e.g.: <code>curl --path-as-is https://api.example.com/sdalksjdeiu23432/cutomer-serivice/endpoint1</code></p><figure><img src=https://user-images.githubusercontent.com/17719543/139599207-a1c661f7-ac5f-421b-a48f-eabc8c2cea81.png></figure><p>This <code>sdalksjdeiu23432</code> is just not existing service. You can see that there is nginx in response.</p><h2 id=normalization-of-and2f>Normalization of ../ and ..%2F</h2><p>It&rsquo;s good to check what is happening for normalization of paths. Between your machine and ingress could be other servers, e.g: additional proxies or WAF (Web Application Firewall).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl --path-as-is https://api.example.com/sdalksjdeiu23432/../cutomer-serivice/endpoint1
</span></span><span class=line><span class=cl>curl --path-as-is https://api.example.com/sdalksjdeiu23432/..%2F/cutomer-serivice/endpoint1
</span></span><span class=line><span class=cl>curl --path-as-is https://api.example.com/sdalksjdeiu23432/..%252Fcutomer-serivice/endpoint1 <span class=c1># double encoding</span>
</span></span></code></pre></td></tr></table></div></div><p>Comparing results could give you idea about path normalization.</p><h2 id=external-authentication-service>External authentication service</h2><p>This is quite hard to investigate. Idea behind external authentication service is about having it centralized. Having broken authentication proof (e.g. JWT) would issue 401/403 on ingress rather than on upstream.</p><p>I would follow those steps:</p><ol><li>Login into application</li><li>Get some request to backend service</li><li>Change it in a way that authentication proof is broken. For JWT it would be just to place any character into it.</li><li>Send changed request and see results</li></ol><p>Something that you would like to see is:</p><figure><img src=https://user-images.githubusercontent.com/17719543/139599242-26908b17-554a-4737-af2c-6f163bb0560e.png></figure><p>If you cannot get any indication whether centralized authentication is in place, you can also assume so and try to exploit.</p><h2 id=centralized-authorization>Centralized authorization</h2><p>Authentication service is checking if you are who you are talking to be. But authorization is making decisions about letting you do some action. Having it centralized in some way is necessary for exploitation. If backend services are doing access control on they own, there is <strong>no way</strong> to exploit it with presented bypass.</p><p>You can do assumption here, that there is centralized authorization and move on.</p><h2 id=exploitation>Exploitation</h2><h3 id=public-service>Public service</h3><p>Try to find service that is handling requests for anyone. Without any authentication proof. Some kind of public service. If you have one, that&rsquo;s good, if you don&rsquo;t have there is still one thing you can do (described in next paragraph).</p><p>OK. We have some <code>public-service</code> and also <code>protected-service</code> that is only for logged in users (e.g. with valid JWT token). </p><p>Do some tests:</p><ol><li>Take a valid request to protected service, e.g. <code>/protected-service/protected?a=1</code> and change it to <code>/public-service/..%2Fprotected-service/protected?a=1</code> but send it <strong>without any token</strong>. </li><li>Make token invalid and send request from point 1.</li><li>Wait and make token expired and send request from point 1.</li></ol><p>What responses did you get? In case of luck you are already getting valid response for point 1. If not maybe point 2 or 3 was successful for you. If not try with different public and protected services. If you still get no valid response it means that there is no vulnerability here.</p><h3 id=privilege-escalation>Privilege escalation</h3><p>There could be implementation of centralized access control that is checking to which group/role user belong.</p><p>In this situation try following steps:</p><ol><li>Find endpoint that you cannot access. </li><li>Take a valid request with authentication proof (e.g. JWT).</li><li>Send request to endpoint from point 1, but using path traversal described in previous paragraph.</li></ol><p>If you didn&rsquo;t success it means that there is no vulnerability here. Sadly… ☹️</p><h2 id=summary>Summary</h2><p>I have presented steps that can be inspiration for you. Do not limit yourself and be creative. Happy hunting!</p><h3 id=other-articles-from-this-series>Other articles from this series</h3><ul><li><a class=link href=https://xvnpw.github.io/posts/cve_2021_43557_apache_apisix_path_traversal_in_request_uri_variable/>CVE-2021-43557: Apache APISIX: Path traversal in request_uri variable</a></li><li><a class=link href=https://xvnpw.github.io/posts/path_traversal_in_authorization_context_in_traefik_and_haproxy/>Path traversal in authorization context in Traefik and HAProxy</a></li><li><a class=link href=https://xvnpw.github.io/posts/path_traversal_in_authorization_context_in_emissary/>Path traversal in authorization context in Emissary</a></li><li><a class=link href=https://xvnpw.github.io/posts/path_traversal_in_authorization_context_in_kong_and_f5_nginx/>Path traversal in authorization context in Kong and F5 NGINX</a></li><li><a class=link href=https://xvnpw.github.io/posts/hunting_for_buggy_authentication_authorization_services_on_github/>Hunting for buggy authentication/authorization services on github</a></li></ul><hr><p>Thanks for reading! You can follow me on <a class=link href=https://twitter.com/xvnpw target=_blank rel=noopener>Twitter</a>.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/kubernetes/>kubernetes</a>
<a href=/tags/nginx/>nginx</a>
<a href=/tags/kong/>kong</a>
<a href=/tags/f5/>F5</a>
<a href=/tags/apisix/>apisix</a>
<a href=/tags/path-traversal/>path-traversal</a>
<a href=/tags/bugbounty/>bugbounty</a></section></footer></article><aside class=related-contents--wrapper><h2 class=section-title>Related contents</h2><div class=related-contents><div class="flex article-list--tile"><article><a href=/posts/external_authentication_bypass_in_ingress_nginx/><div class=article-details><h2 class=article-title>External Authentication bypass in ingress-nginx</h2></div></a></article><article><a href=/posts/hunting_for_buggy_authentication_authorization_services_on_github/><div class=article-details><h2 class=article-title>Hunting for buggy authentication/authorization services on github</h2></div></a></article><article><a href=/posts/path_traversal_in_authorization_context_in_kong_and_f5_nginx/><div class=article-details><h2 class=article-title>Path traversal in authorization context in Kong and F5 NGINX</h2></div></a></article><article><a href=/posts/cve_2021_43557_apache_apisix_path_traversal_in_request_uri_variable/><div class=article-details><h2 class=article-title>CVE-2021-43557: Apache APISIX: Path traversal in request_uri variable</h2></div></a></article><article><a href=/posts/path_traversal_in_authorization_context_in_emissary/><div class=article-details><h2 class=article-title>Path traversal in authorization context in Emissary</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2020 -
2022 xvnpw personal blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.11.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#apis>APIs</a></li><li><a href=#using-paths>Using paths</a></li><li><a href=#using-nginx-based-ingress-controller>Using nginx based ingress controller</a></li><li><a href=#normalization-of-and2f>Normalization of ../ and ..%2F</a></li><li><a href=#external-authentication-service>External authentication service</a></li><li><a href=#centralized-authorization>Centralized authorization</a></li><li><a href=#exploitation>Exploitation</a><ol><li><a href=#public-service>Public service</a></li><li><a href=#privilege-escalation>Privilege escalation</a></li></ol></li><li><a href=#summary>Summary</a><ol><li><a href=#other-articles-from-this-series>Other articles from this series</a></li></ol></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>