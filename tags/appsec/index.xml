<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>appsec on xvnpw personal blog</title><link>https://xvnpw.github.io/tags/appsec/</link><description>Recent content in appsec on xvnpw personal blog</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Mon, 01 Feb 2021 10:14:47 +0100</lastBuildDate><atom:link href="https://xvnpw.github.io/tags/appsec/index.xml" rel="self" type="application/rss+xml"/><item><title>Azure subscription securityÂ review</title><link>https://xvnpw.github.io/posts/azure-subscription-security-review/</link><pubDate>Mon, 01 Feb 2021 10:14:47 +0100</pubDate><guid>https://xvnpw.github.io/posts/azure-subscription-security-review/</guid><description>&lt;p>{{ template &amp;ldquo;_internal/google_analytics.html&amp;rdquo; . }}&lt;/p>
&lt;p>Lately I have come across task to perform security review of Azure subscription. It was white-box based and I had access to all terraform, Kubernetes and Docker files. I will share with you what checks are worth to do for such review.&lt;/p>
&lt;figure class="center">&lt;img src="https://user-images.githubusercontent.com/17719543/139584399-d5004590-c179-4a87-8c21-aa364f53e293.png"/>
&lt;/figure>
&lt;h2 id="my-methodology">My methodology&lt;/h2>
&lt;p>Number of resources to check may vary from project to project. For me best approach is to mix automated tools with manual work. If it&amp;rsquo;s possible I&amp;rsquo;m using two tools for same purpose. It makes my life easier as I don&amp;rsquo;t need to choose best tool ðŸ™‚ It&amp;rsquo;s also improving results.&lt;/p>
&lt;p>I categorize findings into groups:&lt;/p>
&lt;ul>
&lt;li>Criticalâ€Š-â€Šneed to contact team and fix immediately&lt;/li>
&lt;li>Highâ€Š-â€Šneed to be fixed by team&lt;/li>
&lt;li>Mediumâ€Š-â€Šnice to be fixed&lt;/li>
&lt;li>Lowâ€Š-â€Šleast important to fix&lt;/li>
&lt;/ul>
&lt;h3 id="0Âº-scope-definition">0Âº Scope definition&lt;/h3>
&lt;p>Before starting any actual work, we need to define scope. In many cases it will directly come from team that created resources in Azure. In that case schedule meeting with them and note all important information:&lt;/p>
&lt;ul>
&lt;li>what is name of Azure subscription to test (you don&amp;rsquo;t want to review wrong one!)&lt;/li>
&lt;li>what is usage of subscription: e.g. production environment for web applicationÂ ?&lt;/li>
&lt;li>link to repository with terraform/Kubernetes/Docker files&lt;/li>
&lt;li>any diagrams reflecting how components are communicating, e.g. UML component diagram or network schema&lt;/li>
&lt;li>ask team to go briefly with Azure resources descriptionâ€Š-â€Šno need to be detailed at this point&lt;/li>
&lt;li>what is team priority for reviewâ€Š-â€Šthis is quite important question. On one hand it shows expectations from team, but also can potentially reveal strong and weak sides of configuration.&lt;/li>
&lt;li>establish with team way to contact during review. This time you can give some your expectations, e.g. do status meetings daily and contact immediately on critical findings.&lt;/li>
&lt;/ul>
&lt;h3 id="1Âº-turn-on-azuredefender">1Âº Turn on AzureÂ Defender&lt;/h3>
&lt;p>Now it&amp;rsquo;s finally time to go into Azure portal.&lt;/p>
&lt;p>At beginning my first steps are into Security Center to turn on paid version of it (currently named Azure Defender). This will do additional scanning and give results of regulatory compliance, e.g. ISO 27001, PCI DSS. Generally speaking this paid version &lt;strong>should be turned on already&lt;/strong> at this point as it&amp;rsquo;s giving a lot into cloud security.&lt;/p>
&lt;p>Security Center is based in some part on logs coming from agents, so let&amp;rsquo;s give it some time to run.&lt;/p>
&lt;h3 id="2Âº-manualcheck">2Âº ManualÂ check&lt;/h3>
&lt;p>Having head full of knowledge from scope definition it&amp;rsquo;s time to get familiar with target subscription. This step is based more on intuition than strictly technical. Try to go from resource to resource checking network and security configuration. If something is having &amp;ldquo;bad smell&amp;rdquo; just follow it to clarify for 100% whether is good or not. Typically I look for:&lt;/p>
&lt;ul>
&lt;li>open Storage Accounts&lt;/li>
&lt;li>open ports in Network Security Groups (NSGs)&lt;/li>
&lt;li>not protected Virtual Machines&lt;/li>
&lt;li>misconfiguration in deployed services: databases, Elasticsearch, Redis, etc.&lt;/li>
&lt;li>wrong or to permissive RBAC roles assignment&lt;/li>
&lt;/ul>
&lt;h3 id="3Âº-terraform-filescheck">3Âº Terraform filesÂ check&lt;/h3>
&lt;p>If you are lucky and team is using Infrastructure as a Code, you can test it with automated tools. There are good in finding typical misconfiguration. For terraform I&amp;rsquo;m using two:&lt;/p>
&lt;ul>
&lt;li>&lt;a class="link" href="https://github.com/bridgecrewio/checkov" target="_blank" rel="noopener"
>https://github.com/bridgecrewio/checkov&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://github.com/tfsec/tfsec" target="_blank" rel="noopener"
>https://github.com/tfsec/tfsec&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="4Âº-kubernetes-deployments-check">4Âº Kubernetes deployments check&lt;/h3>
&lt;p>Kubernetes files also can be checked with automated tools. The other way is to check configuration by deploying audit application into cluster. It has benefits as it constantly reporting. It can be running after audit to make team aware about problems.&lt;/p>
&lt;p>In my case, I was checking Helm scripts. If you don&amp;rsquo;t know Helm, it&amp;rsquo;s templating language for Kubernetes. In order to check template I needed first to generate Kubernetes files based on template and values. For most simple case you need to run:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">helm template reviewÂ ./ &amp;gt; output.yaml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>I have choose checkov to test Kubernetes files:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">checkov --quiet -f output.yaml &amp;gt; checkov.result.txt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Second tool that I recommending is kube-scan deployed into cluster:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">az login
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">az aks get-credentials -resource-group myResourceGroup -name myAKSCluster
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubectl apply -f https://raw.githubusercontent.com/octarinesec/kube-scan/master/kube-scan-lb.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubectl -n kube-scan get service kube-scan-ui
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="5Âº-dockercheck">5Âº DockerÂ check&lt;/h3>
&lt;p>Dockerfiles can have misconfiguration and docker container can have vulnerabilities, e.g. outdated system packages.&lt;/p>
&lt;p>For checking Dockerfiles I used &lt;a class="link" href="https://github.com/hadolint/hadolint" target="_blank" rel="noopener"
>https://github.com/hadolint/hadolint&lt;/a>:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">docker run --rm -i hadolint/hadolint &amp;lt; Dockerfile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>and for docker containers &lt;a class="link" href="https://github.com/anchore/anchore-engine" target="_blank" rel="noopener"
>https://github.com/anchore/anchore-engine&lt;/a>:&lt;/p>
&lt;script type="application/javascript" src="https://gist.github.com/xvnpw/7e7dda58486e4f661f9b46b51dcbe79c.js">&lt;/script>
&lt;h3 id="6Âº-complex-security-audittool">6Âº Complex security auditÂ tool&lt;/h3>
&lt;p>Last step in checking is based on tool that is doing complex whole subscription check based on numerous rules, mostly coming from &lt;a class="link" href="https://www.cisecurity.org/benchmark/azure/" target="_blank" rel="noopener"
>CIS Benchmarks&lt;/a>.&lt;/p>
&lt;p>The only tool worth mention that I have found is &lt;a class="link" href="https://github.com/nccgroup/ScoutSuite" target="_blank" rel="noopener"
>https://github.com/nccgroup/ScoutSuite&lt;/a>. It can check not only Azure but also AWS and GCP.&lt;/p>
&lt;p>I had problem in running ScoutSuite on my local machine, so I did run it eventually on Docker. Problem was related to my version of python.&lt;/p>
&lt;script type="application/javascript" src="https://gist.github.com/xvnpw/ec08c001b41f29a7f1bb199150fdb7f3.js">&lt;/script>
&lt;h3 id="7Âº-writing-report-if-not-didyet">7Âº Writing report (if not didÂ yet)&lt;/h3>
&lt;p>Best way to write report is to do it during review. So that you can take screenshots along the way.&lt;/p>
&lt;h2 id="summary">Summary&lt;/h2>
&lt;p>I must say that I&amp;rsquo;m enjoying this kind of tasks in my work ðŸ™‚ There are good tools and in most cases running smoothly. Biggest problems I had in playing with &lt;code>anchor&lt;/code> and &lt;code>ScoutSuite&lt;/code>.&lt;/p>
&lt;p>Findings? In my case there were some critical one. Sadly team didn&amp;rsquo;t spot right recommendations in Azure Security Center on time. Monitoring those recommendations manually is not easy for development teams. Good thing is that Azure is giving some options for notifications.&lt;/p>
&lt;p>Please share in comments your ideas about Azure review. What tools are good for you?&lt;/p>
&lt;hr>
&lt;p>Thanks for reading! You can follow me on &lt;a class="link" href="https://twitter.com/xvnpw" target="_blank" rel="noopener"
>Twitter&lt;/a>.&lt;/p></description></item><item><title>Hacking SpEL</title><link>https://xvnpw.github.io/posts/hacking-spel/</link><pubDate>Fri, 17 Jul 2020 10:14:47 +0100</pubDate><guid>https://xvnpw.github.io/posts/hacking-spel/</guid><description>&lt;p>This story will explain how to find and exploit SpEL parser in web applications based on Java language.&lt;/p>
&lt;p>What is SpELÂ ? From Spring documentation:&lt;/p>
&lt;blockquote>
&lt;p>The Spring Expression Language (SpEL for short) is a powerful expression language that supports querying and manipulating an object graph at runtime.&lt;/p>
&lt;/blockquote>
&lt;p>Where is it usedÂ ?&lt;/p>
&lt;ol>
&lt;li>Spring Framework: Security, Data,Â â€¦&lt;/li>
&lt;li>&lt;strong>Any place developers use it by SpEL API&lt;/strong>&lt;/li>
&lt;li>For languages it can be used in Java, Kotlin, Scala, and other JVM based technologies.&lt;/li>
&lt;/ol>
&lt;p>First point is known by issues in past like: &lt;a class="link" href="https://tanzu.vmware.com/security/cve-2018-1273" target="_blank" rel="noopener"
>CVE-2018â€“1273&lt;/a>, &lt;a class="link" href="https://tanzu.vmware.com/security/cve-2017-8046" target="_blank" rel="noopener"
>CVE-2017â€“8046&lt;/a> or CVE-2011â€“2730. I will not talk about them, I will focus on point number two.&lt;/p>
&lt;h2 id="spel-api">SpEL API&lt;/h2>
&lt;p>Most common use cases for SpEL that I have seen in web applications:&lt;/p>
&lt;ul>
&lt;li>complex expressions using custom function calls: &lt;code>fun1(&amp;quot;some string&amp;quot;)Â ? &amp;quot;text&amp;quot;Â : fun2(&amp;quot;some other string&amp;quot;)&lt;/code>&lt;/li>
&lt;li>dynamic code evaluation: &lt;code>T(org.springframework.util.StreamUtils).copy(T(java.lang.Runtime).getRuntime().execâ€¦&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>Any of user input can be part of expression. Also input can be expression as a whole. Those above use cases are good indicators what to look for in web apps. Key words: &lt;strong>expression, mapping, dynamic&lt;/strong> ðŸ˜ƒ&lt;/p>
&lt;h2 id="payloads">Payloads&lt;/h2>
&lt;p>From you have already see I bet you know what is coming. If developers are using SpEL with user input, we need to create payload with injection. Let&amp;rsquo;s check one that allow remote code execution (RCE). It was created as part of exploit for &lt;a class="link" href="https://github.com/m3ssap0/SpringBreakVulnerableApp" target="_blank" rel="noopener"
>CVE-2017â€“8046&lt;/a>.&lt;/p>
&lt;figure>&lt;img src="https://user-images.githubusercontent.com/17719543/139583765-7570579f-f233-483c-8334-5f664caeb4e9.png"/>
&lt;/figure>
&lt;p>It consist of 3 parts:&lt;/p>
&lt;ul>
&lt;li>black colorâ€Š-â€Šcopy result of command execution directly to output stream of HTTP request&lt;/li>
&lt;li>red colorâ€Š-â€Šget Java Runtime and execute command in system&lt;/li>
&lt;li>blue colorâ€Š-â€ŠString containing command: &lt;code>cmd /c dir&lt;/code>. To make it more robust individual characters of command are decoded from numbers.&lt;/li>
&lt;/ul>
&lt;p>Result of executing it:&lt;/p>
&lt;figure>&lt;img src="https://user-images.githubusercontent.com/17719543/139583810-50b2ec88-a69f-4acf-9848-29aeb18b6e9f.png"/>
&lt;/figure>
&lt;p>Code of intentionally vulnerable web application:&lt;/p>
&lt;script type="application/javascript" src="https://gist.github.com/xvnpw/658e7f6f0d1c11f4d17f4cf96494ae59.js">&lt;/script>
&lt;p>Keep in mind:&lt;/p>
&lt;ul>
&lt;li>payload is working in some of Blind scenariosâ€Š-â€Šalways copy result to HTTP response&lt;/li>
&lt;li>can be tune to work on Linuxâ€Š-â€Šjust remove &lt;code>cmd /c&lt;/code> and it should work out-of-box&lt;/li>
&lt;li>in real world you will need probably first break out of string to inject this or do other tricks that are common for injection attacks&lt;/li>
&lt;li>it can be used with multiple versions of String Framework and Java&lt;/li>
&lt;/ul>
&lt;p>Here is payload to copy:&lt;/p>
&lt;script type="application/javascript" src="https://gist.github.com/xvnpw/85aa53c3e1b17d3515e8e3d43985a060.js">&lt;/script>
&lt;p>The other interesting payload is this one:&lt;/p>
&lt;figure>&lt;img src="https://user-images.githubusercontent.com/17719543/139584003-8228ebaf-0a98-4028-9340-ee50a6f4bff5.png"/>
&lt;/figure>
&lt;p>It&amp;rsquo;s far less complicated but short and powerful. It&amp;rsquo;s also not using &lt;code>T(...)&lt;/code> syntax and no constructor is used. It&amp;rsquo;s just executing methods and accessing properties. I will show in next part why it does matter.&lt;/p>
&lt;p>Check more payloads for SpEL in my repository: &lt;a class="link" href="https://github.com/xvnpw/hacking/blob/master/payloads/spel-injections.txt" target="_blank" rel="noopener"
>https://github.com/xvnpw/hacking/blob/master/payloads/spel-injections.txt&lt;/a>&lt;/p>
&lt;h2 id="summary">Summary&lt;/h2>
&lt;p>That will be all for this part. I have explained what is SpEL API and how to exploit it. In next part I will deep dive into Spring source code to show how exactly it works.&lt;/p>
&lt;hr>
&lt;p>Thanks for reading! You can follow me on &lt;a class="link" href="https://twitter.com/xvnpw" target="_blank" rel="noopener"
>Twitter&lt;/a>.&lt;/p></description></item></channel></rss>