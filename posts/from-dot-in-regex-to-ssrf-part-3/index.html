<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>From . in regex to SSRF‚Ää-‚Ääpart 3 - xvnpw personal blog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="This is last part of my stories about exploiting service with SSRF bug. Part 1 is available here, and part 2 here. This part is focused on abusing Node.js and node-fetch library. I will try to ‚Äútalk‚Äù with Redis service using CRLF injection in http parser."><meta property="og:image" content><meta property="og:title" content="From . in regex to SSRF‚Ää-‚Ääpart 3"><meta property="og:description" content="This is last part of my stories about exploiting service with SSRF bug. Part 1 is available here, and part 2 here. This part is focused on abusing Node.js and node-fetch library. I will try to ‚Äútalk‚Äù with Redis service using CRLF injection in http parser."><meta property="og:type" content="article"><meta property="og:url" content="https://xvnpw.github.io/posts/from-dot-in-regex-to-ssrf-part-3/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-07-07T10:14:47+01:00"><meta property="article:modified_time" content="2020-07-07T10:14:47+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="From . in regex to SSRF‚Ää-‚Ääpart 3"><meta name=twitter:description content="This is last part of my stories about exploiting service with SSRF bug. Part 1 is available here, and part 2 here. This part is focused on abusing Node.js and node-fetch library. I will try to ‚Äútalk‚Äù with Redis service using CRLF injection in http parser."><script src=https://xvnpw.github.iojs/feather.min.js></script>
<link href=https://xvnpw.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://xvnpw.github.io/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://xvnpw.github.io/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css media="(prefers-color-scheme: dark)"><link rel=stylesheet type=text/css href=https://xvnpw.github.io/css/my.0b83e2a92adf566deab02a012390927b24d79d5dc5a21a839eb61419dc041acc.css></head><body><div class=content><header><div class=main><a href=https://xvnpw.github.io>xvnpw personal blog</a></div><nav><a href=/>Home</a>
<a href=/posts>All posts</a>
<a href=/about>About</a>
<a href=/tags>Tags</a></nav></header><main><article><div class=title><h1 class=title>From . in regex to SSRF‚Ää-‚Ääpart 3</h1><div class=meta>Posted on Jul 7, 2020</div></div><section class=body><p>This is last part of my stories about exploiting service with SSRF bug. Part 1 is available <a href=https://xvnpw.github.io/posts/from-dot-in-regex-to-ssrf-part-1/>here</a>, and part 2 <a href=https://xvnpw.github.io/posts/from-dot-in-regex-to-ssrf-part-2/>here</a>.</p><p>This part is focused on abusing Node.js and <em>node-fetch</em> library. I will try to &ldquo;talk&rdquo; with Redis service using CRLF injection in http parser.</p><p>For convenience Redis service will be simulated by <code>nc -vvlp 6379</code>.</p><p>Test environment from my Kali 2020.1b:</p><ul><li>Node.js version 10.19.0</li><li>node-fetch version 2.6.0</li></ul><h2 id=crlf-injection>CRLF Injection</h2><p>Lets start with PayloadsAllTheThings. It contains couple of CRLF Injection payloads. I will loop over them and check result in second console:</p><figure><img src=https://user-images.githubusercontent.com/17719543/139583089-ecf56f8e-5c1a-465d-b0ff-01204ef313aa.png></figure><p>None success here. All payloads failed üôÅ</p><p>Next step is to check payloads from two great articles by Orange Tsai: <a href=https://www.blackhat.com/docs/us-17/thursday/us-17-Tsai-A-New-Era-Of-SSRF-Exploiting-URL-Parser-In-Trending-Programming-Languages.pdf>first from Red Hat 2017</a> and <a href=https://blog.orange.tw/2017/07/how-i-chained-4-vulnerabilities-on.html>second from his blog</a>. It&rsquo;s giving few more options to test:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>ÔºçÔºäSet-Cookie:injectionÔºçÔºä (Unicode U+FF0D U+FF0A)
</span></span><span style=display:flex><span>http://0\r\n SET foo 0 60 5\r\n :6379/
</span></span><span style=display:flex><span>https://0\r\nSET foo 0 60 5\r\n:6379/
</span></span></code></pre></div><p>Still no success here. I seams that this version of Node.js is not vulnerable for CRLF attacks.</p><p>Let&rsquo;s try harder and dig dipper into node-fetch, maybe something interesting will be in code üòÉ</p><h2 id=investigation-of-node-fetch-code>Investigation of node-fetch code</h2><p>What am I trying to achieve here? I have in mind two types of possible errors:</p><ol><li>Url parsing</li><li>Handling url input as object not as <em>string</em></li></ol><p>Let&rsquo;s see what I will find.</p><p>Debug of Node.js code is quite nice with Visual Studio Code:</p><figure><img src=https://user-images.githubusercontent.com/17719543/139583200-2686e457-092e-4385-8a01-f7716babf711.png></figure><p>Problem number one is not existing as node-fetch is using standard Node.js <code>Url.parse</code> for input. There are not doing much fancy stuff with it.</p><p>For second problem I needed to do more investigation.</p><p>First of all I will explain why I&rsquo;m interested in processing <em>object</em> instead of <em>string</em>. In many dynamic languages you can make valid request like this:</p><p><code>http://localhost:3000/c?url[href]=localhost&amp;url[method]=POST</code></p><p>This leads to created object instead of string. Could be quite handy for some scenarios. Especially if developers didn&rsquo;t predict it üòÉ See below example of parsing such url in Node.js Express framework.</p><figure><img src=https://user-images.githubusercontent.com/17719543/139583272-0e1f3070-7ec9-44a3-8df7-ac9cf858d883.png></figure><p>In node-fetch I have found one possible attacking vector:</p><figure><img src=https://user-images.githubusercontent.com/17719543/139583293-12f60351-0548-41c5-a92b-45711eac279f.png></figure><p>It look like possible to use object instead of string for input parameter. This <code>input.method</code> could change method type in some specific conditions. After spending some time in debugger it turn out as <strong>dead end</strong>.</p><h2 id=summary>Summary</h2><p>I didn&rsquo;t manage to escalate blind SSRF to anything more. I have spent couple of days trying different approaches. Nevertheless after submitting report I was awarded with <strong>400$</strong> and bug was marked as <strong>medium</strong>.</p><hr><p>Thanks for reading! You can follow me on <a href=https://twitter.com/xvnpw>Twitter</a>.</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/ssrf>SSRF</a></li><li><a href=/tags/bugbounty>bugbounty</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/xvnpw rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/xvnpw rel=me title=Twitter><i data-feather=twitter></i></a>
<a class=border></a></div><div class=footer-info>2023 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script>feather.replace()</script></div></body></html>