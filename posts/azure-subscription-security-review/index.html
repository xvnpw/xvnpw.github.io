<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Lately I have come across task to perform security review of Azure subscription. It was white-box based and I had access to all terraform, Kubernetes and Docker files. I will share with you what checks are worth to do for such review."><title>Azure subscription securityÂ review</title><link rel=canonical href=https://xvnpw.github.io/posts/azure-subscription-security-review/><link rel=stylesheet href=/scss/style.min.450926226e724574a6b936335ea06111f8aeb253d932c86cb2cc807341cd2889.css><meta property="og:title" content="Azure subscription securityÂ review"><meta property="og:description" content="Lately I have come across task to perform security review of Azure subscription. It was white-box based and I had access to all terraform, Kubernetes and Docker files. I will share with you what checks are worth to do for such review."><meta property="og:url" content="https://xvnpw.github.io/posts/azure-subscription-security-review/"><meta property="og:site_name" content="xvnpw personal blog"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="azure"><meta property="article:tag" content="devops"><meta property="article:tag" content="appsec"><meta property="article:published_time" content="2021-02-01T10:14:47+01:00"><meta property="article:modified_time" content="2021-02-01T10:14:47+01:00"><meta name=twitter:site content="@xvnpw"><meta name=twitter:creator content="@xvnpw"><meta name=twitter:title content="Azure subscription securityÂ review"><meta name=twitter:description content="Lately I have come across task to perform security review of Azure subscription. It was white-box based and I had access to all terraform, Kubernetes and Docker files. I will share with you what checks are worth to do for such review."><script async src="https://www.googletagmanager.com/gtag/js?id=G-YHETMXZXMZ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YHETMXZXMZ",{anonymize_ip:!1})}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=https://user-images.githubusercontent.com/17719543/142780058-1ede8ab3-567f-471f-b802-788efca3684f.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>xvnpw personal blog</a></h1><h2 class=site-description>hacking, bug bounty, appsec</h2></div></header><ol class=social-menu><li><a href=https://github.com/xvnpw target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/xvnpw target=_blank title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/posts/azure-subscription-security-review/>Azure subscription securityÂ review</a></h2><h3 class=article-subtitle>Lately I have come across task to perform security review of Azure subscription. It was white-box based and I had access to all terraform, Kubernetes and Docker files. I will share with you what checks are worth to do for such review.</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Feb 01, 2021</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>5 minute read</time></div></footer></div></header><section class=article-content><p>{{ template &ldquo;_internal/google_analytics.html&rdquo; . }}</p><p>Lately I have come across task to perform security review of Azure subscription. It was white-box based and I had access to all terraform, Kubernetes and Docker files. I will share with you what checks are worth to do for such review.</p><figure class=center><img src=https://user-images.githubusercontent.com/17719543/139584399-d5004590-c179-4a87-8c21-aa364f53e293.png></figure><h2 id=my-methodology>My methodology</h2><p>Number of resources to check may vary from project to project. For me best approach is to mix automated tools with manual work. If it&rsquo;s possible I&rsquo;m using two tools for same purpose. It makes my life easier as I don&rsquo;t need to choose best tool ðŸ™‚ It&rsquo;s also improving results.</p><p>I categorize findings into groups:</p><ul><li>Criticalâ€Š-â€Šneed to contact team and fix immediately</li><li>Highâ€Š-â€Šneed to be fixed by team</li><li>Mediumâ€Š-â€Šnice to be fixed</li><li>Lowâ€Š-â€Šleast important to fix</li></ul><h3 id=0Âº-scope-definition>0Âº Scope definition</h3><p>Before starting any actual work, we need to define scope. In many cases it will directly come from team that created resources in Azure. In that case schedule meeting with them and note all important information:</p><ul><li>what is name of Azure subscription to test (you don&rsquo;t want to review wrong one!)</li><li>what is usage of subscription: e.g. production environment for web applicationÂ ?</li><li>link to repository with terraform/Kubernetes/Docker files</li><li>any diagrams reflecting how components are communicating, e.g. UML component diagram or network schema</li><li>ask team to go briefly with Azure resources descriptionâ€Š-â€Šno need to be detailed at this point</li><li>what is team priority for reviewâ€Š-â€Šthis is quite important question. On one hand it shows expectations from team, but also can potentially reveal strong and weak sides of configuration.</li><li>establish with team way to contact during review. This time you can give some your expectations, e.g. do status meetings daily and contact immediately on critical findings.</li></ul><h3 id=1Âº-turn-on-azuredefender>1Âº Turn on AzureÂ Defender</h3><p>Now it&rsquo;s finally time to go into Azure portal.</p><p>At beginning my first steps are into Security Center to turn on paid version of it (currently named Azure Defender). This will do additional scanning and give results of regulatory compliance, e.g. ISO 27001, PCI DSS. Generally speaking this paid version <strong>should be turned on already</strong> at this point as it&rsquo;s giving a lot into cloud security.</p><p>Security Center is based in some part on logs coming from agents, so let&rsquo;s give it some time to run.</p><h3 id=2Âº-manualcheck>2Âº ManualÂ check</h3><p>Having head full of knowledge from scope definition it&rsquo;s time to get familiar with target subscription. This step is based more on intuition than strictly technical. Try to go from resource to resource checking network and security configuration. If something is having &ldquo;bad smell&rdquo; just follow it to clarify for 100% whether is good or not. Typically I look for:</p><ul><li>open Storage Accounts</li><li>open ports in Network Security Groups (NSGs)</li><li>not protected Virtual Machines</li><li>misconfiguration in deployed services: databases, Elasticsearch, Redis, etc.</li><li>wrong or to permissive RBAC roles assignment</li></ul><h3 id=3Âº-terraform-filescheck>3Âº Terraform filesÂ check</h3><p>If you are lucky and team is using Infrastructure as a Code, you can test it with automated tools. There are good in finding typical misconfiguration. For terraform I&rsquo;m using two:</p><ul><li><a class=link href=https://github.com/bridgecrewio/checkov target=_blank rel=noopener>https://github.com/bridgecrewio/checkov</a></li><li><a class=link href=https://github.com/tfsec/tfsec target=_blank rel=noopener>https://github.com/tfsec/tfsec</a></li></ul><h3 id=4Âº-kubernetes-deployments-check>4Âº Kubernetes deployments check</h3><p>Kubernetes files also can be checked with automated tools. The other way is to check configuration by deploying audit application into cluster. It has benefits as it constantly reporting. It can be running after audit to make team aware about problems.</p><p>In my case, I was checking Helm scripts. If you don&rsquo;t know Helm, it&rsquo;s templating language for Kubernetes. In order to check template I needed first to generate Kubernetes files based on template and values. For most simple case you need to run:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm template reviewÂ ./ &gt; output.yaml
</span></span></code></pre></td></tr></table></div></div><p>I have choose checkov to test Kubernetes files:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>checkov --quiet -f output.yaml &gt; checkov.result.txt
</span></span></code></pre></td></tr></table></div></div><p>Second tool that I recommending is kube-scan deployed into cluster:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>az login
</span></span><span class=line><span class=cl>az aks get-credentials -resource-group myResourceGroup -name myAKSCluster
</span></span><span class=line><span class=cl>kubectl apply -f https://raw.githubusercontent.com/octarinesec/kube-scan/master/kube-scan-lb.yaml
</span></span><span class=line><span class=cl>kubectl -n kube-scan get service kube-scan-ui
</span></span></code></pre></td></tr></table></div></div><h3 id=5Âº-dockercheck>5Âº DockerÂ check</h3><p>Dockerfiles can have misconfiguration and docker container can have vulnerabilities, e.g. outdated system packages.</p><p>For checking Dockerfiles I used <a class=link href=https://github.com/hadolint/hadolint target=_blank rel=noopener>https://github.com/hadolint/hadolint</a>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run --rm -i hadolint/hadolint &lt; Dockerfile
</span></span></code></pre></td></tr></table></div></div><p>and for docker containers <a class=link href=https://github.com/anchore/anchore-engine target=_blank rel=noopener>https://github.com/anchore/anchore-engine</a>:</p><script type=application/javascript src=https://gist.github.com/xvnpw/7e7dda58486e4f661f9b46b51dcbe79c.js></script><h3 id=6Âº-complex-security-audittool>6Âº Complex security auditÂ tool</h3><p>Last step in checking is based on tool that is doing complex whole subscription check based on numerous rules, mostly coming from <a class=link href=https://www.cisecurity.org/benchmark/azure/ target=_blank rel=noopener>CIS Benchmarks</a>.</p><p>The only tool worth mention that I have found is <a class=link href=https://github.com/nccgroup/ScoutSuite target=_blank rel=noopener>https://github.com/nccgroup/ScoutSuite</a>. It can check not only Azure but also AWS and GCP.</p><p>I had problem in running ScoutSuite on my local machine, so I did run it eventually on Docker. Problem was related to my version of python.</p><script type=application/javascript src=https://gist.github.com/xvnpw/ec08c001b41f29a7f1bb199150fdb7f3.js></script><h3 id=7Âº-writing-report-if-not-didyet>7Âº Writing report (if not didÂ yet)</h3><p>Best way to write report is to do it during review. So that you can take screenshots along the way.</p><h2 id=summary>Summary</h2><p>I must say that I&rsquo;m enjoying this kind of tasks in my work ðŸ™‚ There are good tools and in most cases running smoothly. Biggest problems I had in playing with <code>anchor</code> and <code>ScoutSuite</code>.</p><p>Findings? In my case there were some critical one. Sadly team didn&rsquo;t spot right recommendations in Azure Security Center on time. Monitoring those recommendations manually is not easy for development teams. Good thing is that Azure is giving some options for notifications.</p><p>Please share in comments your ideas about Azure review. What tools are good for you?</p><hr><p>Thanks for reading! You can follow me on <a class=link href=https://twitter.com/xvnpw target=_blank rel=noopener>Twitter</a>.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/azure/>azure</a>
<a href=/tags/devops/>devops</a>
<a href=/tags/appsec/>appsec</a></section></footer></article><footer class=site-footer><section class=copyright>&copy;
2020 -
2022 xvnpw personal blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.11.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#my-methodology>My methodology</a><ol><li><a href=#0Âº-scope-definition>0Âº Scope definition</a></li><li><a href=#1Âº-turn-on-azuredefender>1Âº Turn on AzureÂ Defender</a></li><li><a href=#2Âº-manualcheck>2Âº ManualÂ check</a></li><li><a href=#3Âº-terraform-filescheck>3Âº Terraform filesÂ check</a></li><li><a href=#4Âº-kubernetes-deployments-check>4Âº Kubernetes deployments check</a></li><li><a href=#5Âº-dockercheck>5Âº DockerÂ check</a></li><li><a href=#6Âº-complex-security-audittool>6Âº Complex security auditÂ tool</a></li><li><a href=#7Âº-writing-report-if-not-didyet>7Âº Writing report (if not didÂ yet)</a></li></ol></li><li><a href=#summary>Summary</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>