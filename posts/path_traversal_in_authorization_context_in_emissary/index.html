<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Path traversal in authorization context in Emissary - xvnpw personal blog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="After checking Apache APISIX and Traefik, for path traversal in authZ context, now I will research Emissary ingress.
In Emissary there is feature called Basic authentication, which is very similar to forward authentication discussed in Traefik.
 Emissary-ingress can authenticate incoming requests before routing them to a backing service.
 I can already tell you that Emissary is secure and you cannot bypass using path traversal. What is even better, it&rsquo;s (and envoy) aware of this kind of security concern."><meta property="og:image" content><meta property="og:title" content="Path traversal in authorization context in Emissary"><meta property="og:description" content="After checking Apache APISIX and Traefik, for path traversal in authZ context, now I will research Emissary ingress.
In Emissary there is feature called Basic authentication, which is very similar to forward authentication discussed in Traefik.
 Emissary-ingress can authenticate incoming requests before routing them to a backing service.
 I can already tell you that Emissary is secure and you cannot bypass using path traversal. What is even better, it&rsquo;s (and envoy) aware of this kind of security concern."><meta property="og:type" content="article"><meta property="og:url" content="https://xvnpw.github.io/posts/path_traversal_in_authorization_context_in_emissary/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-11-24T19:59:02+01:00"><meta property="article:modified_time" content="2021-11-24T19:59:02+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Path traversal in authorization context in Emissary"><meta name=twitter:description content="After checking Apache APISIX and Traefik, for path traversal in authZ context, now I will research Emissary ingress.
In Emissary there is feature called Basic authentication, which is very similar to forward authentication discussed in Traefik.
 Emissary-ingress can authenticate incoming requests before routing them to a backing service.
 I can already tell you that Emissary is secure and you cannot bypass using path traversal. What is even better, it&rsquo;s (and envoy) aware of this kind of security concern."><script src=https://xvnpw.github.io/js/feather.min.js></script>
<link href=https://xvnpw.github.io/css/fonts.b685ac6f654695232de7b82a9143a46f9e049c8e3af3a21d9737b01f4be211d1.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://xvnpw.github.io/css/main.2f9b5946627215dc1ae7fa5f82bfc9cfcab000329136befeea5733f21e77d68f.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://xvnpw.github.io/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css media="(prefers-color-scheme: dark)"><link rel=stylesheet type=text/css href=https://xvnpw.github.io/css/my.6c05193fd59255e7809f44153be743523b36838b781ff558a2ca5c9ce14a756e.css></head><body><div class=content><header><div class=main><a href=https://xvnpw.github.io/>xvnpw personal blog</a></div><nav><a href=/>Home</a>
<a href=/posts>All posts</a>
<a href=/about>About</a>
<a href=/tags>Tags</a></nav></header><main><article><div class=title><h1 class=title>Path traversal in authorization context in Emissary</h1><div class=meta>Posted on Nov 24, 2021</div></div><section class=body><figure class=image-center><img src=https://user-images.githubusercontent.com/17719543/139592951-0fafc921-437e-4bb7-b0ee-199dd72b36c3.png></figure><p>After checking Apache APISIX and Traefik, for path traversal in authZ context, now I will research Emissary ingress.</p><p>In Emissary there is feature called <a href=https://www.getambassador.io/docs/emissary/latest/howtos/basic-auth/>Basic authentication</a>, which is very similar to forward authentication discussed in Traefik.</p><blockquote><p>Emissary-ingress can authenticate incoming requests before routing them to a backing service.</p></blockquote><p><strong>I can already tell you that Emissary is secure and you cannot bypass using path traversal</strong>. What is even better, it&rsquo;s (and envoy) aware of this kind of security concern. There is full description in documentation. I encourage you to read it:</p><ul><li><a href=https://www.getambassador.io/docs/edge-stack/latest/topics/running/ambassador/#rejecting-client-requests-with-escaped-slashes>rejecting-client-requests-with-escaped-slashes</a> - although it&rsquo;s not directly for Emissary. It&rsquo;s describing well envoy concerts for escaped slashes</li><li><a href=https://github.com/envoyproxy/envoy/security/advisories/GHSA-xcx5-93pw-jw2w>GHSA-xcx5-93pw-jw2w</a> (CVE-2019‚Äì9901)‚Ää-‚Äädescription of risks associated with normalizing paths in envoy</li><li><a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto>envoy http connection manager options</a>‚Ää-‚Äälook for two particular: <code>normalize_path</code> and <code>path_with_escaped_slashes_action</code></li></ul><p>Emissary is setting <code>normalize_path</code> to <code>true</code> and <code>path_with_escaped_slashes_action</code> to <code>KEEP_UNCHANGED</code>. Which is preventing from path traversal bypass.¬†
In this place I would like to point out difference between Emissary ingress and Edge Stack. The latter is using Filter as <a href=https://www.getambassador.io/docs/edge-stack/latest/topics/running/services/auth-service/>authentication service</a>. I did not cover it in my research.</p><h2 id=setting-thestage>Setting the¬†stage</h2><p>Install Emissary ingress in Kubernetes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm repo add datawire https://app.getambassador.io
</span></span><span style=display:flex><span>helm repo update
</span></span><span style=display:flex><span>kubectl create namespace emissary <span style=color:#f92672>&amp;&amp;</span> helm install emissary-ingress --devel --namespace emissary datawire/emissary-ingress <span style=color:#f92672>&amp;&amp;</span> kubectl -n emissary wait --for condition<span style=color:#f92672>=</span>available --timeout<span style=color:#f92672>=</span>90s deploy -lapp.kubernetes.io/instance<span style=color:#f92672>=</span>emissary-ingress
</span></span></code></pre></div><p>If you need more info check <a href=https://www.getambassador.io/docs/emissary/latest/topics/install/helm/>here</a>.</p><p>Check if all emissary pods are running: <code>kubectl get pods -n emissary</code></p><figure><img src=https://user-images.githubusercontent.com/17719543/139598827-d5ca6657-597d-4c02-b6ea-2b399d1ad828.png></figure><p>Deploy listener:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>getambassador.io/v3alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Listener</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>emissary-ingress-listener-8080</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>emissary</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>HTTP</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>securityModel</span>: <span style=color:#ae81ff>XFP</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hostBinding</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>namespace</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>from</span>: <span style=color:#ae81ff>ALL</span>
</span></span></code></pre></div><p>Deploy auth service definition and Emissary mappings:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>getambassador.io/v3alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>AuthService</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>authentication</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>auth_service</span>: <span style=color:#e6db74>&#34;http://auth-service.default.svc.cluster.local:8080&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>proto</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>path_prefix</span>: <span style=color:#e6db74>&#34;/verify&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>allowed_request_headers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#e6db74>&#34;X-Api-Key&#34;</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>getambassador.io/v3alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Mapping</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>public-service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hostname</span>: <span style=color:#e6db74>&#34;app.test&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>prefix</span>: <span style=color:#ae81ff>/public-service/</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>service</span>: <span style=color:#ae81ff>public-service:8080</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>getambassador.io/v3alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Mapping</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>protected-service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hostname</span>: <span style=color:#e6db74>&#34;app.test&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>prefix</span>: <span style=color:#ae81ff>/protected-service/</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>service</span>: <span style=color:#ae81ff>protected-service:8080</span>
</span></span></code></pre></div><p>Code for <code>auth-service</code> is changed:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> flask <span style=color:#f92672>import</span> Flask, Response, request
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> http <span style=color:#f92672>import</span> HTTPStatus
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app <span style=color:#f92672>=</span> Flask(__name__)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app</span><span style=color:#f92672>.</span>route(<span style=color:#e6db74>&#39;/verify/&lt;path:path&gt;&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>verify</span>(path):
</span></span><span style=display:flex><span>    print(request<span style=color:#f92672>.</span>headers, file<span style=color:#f92672>=</span>sys<span style=color:#f92672>.</span>stderr)
</span></span><span style=display:flex><span>    print(path, file<span style=color:#f92672>=</span>sys<span style=color:#f92672>.</span>stderr)
</span></span><span style=display:flex><span>    api_key <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>headers<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;X-Api-Key&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> path <span style=color:#f92672>and</span> path<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#34;public-service/&#34;</span>):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Response(status <span style=color:#f92672>=</span> HTTPStatus<span style=color:#f92672>.</span>OK)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> api_key <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;secret-api-key&#34;</span>:  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Response(status <span style=color:#f92672>=</span> HTTPStatus<span style=color:#f92672>.</span>OK)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Response(status <span style=color:#f92672>=</span> HTTPStatus<span style=color:#f92672>.</span>UNAUTHORIZED)
</span></span></code></pre></div><p>It&rsquo;s not using headers as Traefik. Instead it&rsquo;s passing requested uri as path into <code>/verify</code> route.</p><h2 id=test>Test</h2><p>Let&rsquo;s check my payloads:</p><h3 id=1-payload>1¬∞ payload</h3><p><code>curl -v http://app.test/public-service/..%2Fprotected-service/protected</code></p><figure><img src=https://user-images.githubusercontent.com/17719543/139598911-64682f0c-a199-4125-b928-5070d8e1a658.png></figure><p>I have got 404. And logs from <code>public-service</code> are giving answer why:</p><figure><img src=https://user-images.githubusercontent.com/17719543/139598944-dd4c4f2e-27f5-46e7-b2d0-1e78a640e4e9.png></figure><p>There is no route defined in <code>public-service</code> that is called <code>/..%2Fprotected-service/protected</code> üòÉ</p><p>What was logged by <code>auth-service</code>:</p><figure><img src=https://user-images.githubusercontent.com/17719543/139598957-8c9c8e9c-d0f9-4bb2-bd35-1ba97270d5b1.png></figure><p>Everything is align. Prefix is <code>public-service</code>, <code>%2F</code> was not decoded (due to <code>path_with_escaped_slashes_action</code> envoy option) and <code>auth-service</code> got right path for decision.</p><h3 id=2-payload>2¬∞ payload</h3><p>With second payload it&rsquo;s a bit different as <code>normalize_path</code> envoy option is set to <code>true</code>.</p><p><code>curl --path-as-is -v http://app.test/public-service/../protected-service/protected</code></p><figure><img src=https://user-images.githubusercontent.com/17719543/139598981-b426d3ac-c5b1-494c-bb11-be05eca1bfc4.png></figure><p>This time it&rsquo;s not 404, but 401. Why¬†? Path was normalized. Everywhere. Not only in routes decision making but also in authentication service. Let&rsquo;s check logs from <code>auth-service</code>:</p><figure><img src=https://user-images.githubusercontent.com/17719543/139599021-1efcd692-eb39-4224-9a41-7a62be8dc67d.png></figure><p>Yep. Logs are confirming this.</p><p>Emissary vs ingress authZ bypass‚Ää-‚Ää1¬†: 0 üòÉ</p><h2 id=summary>Summary</h2><p>Emissary is resistant for ingress authZ bypass using path traversal. I&rsquo;m impressed that both Emissary and envoy are aware of this concern. And whole documentation about it is in place. Also default configuration is secure. I was even looking how to change it to less secure, but didn&rsquo;t find a way üòÖ</p><h3 id=versions-of-components-that-i-wasusing>Versions of components that I was¬†using:</h3><p>minikube v1.23.2 on Microsoft Windows 10 Pro 10.0.19043 Build 19043; Kubernetesa v1.22.2 on Docker 20.10.8; Emissary 2.0.4</p><h3 id=other-articles-from-this-series>Other articles from this series</h3><ul><li><a href=https://xvnpw.github.io/posts/cve_2021_43557_apache_apisix_path_traversal_in_request_uri_variable/>CVE-2021-43557: Apache APISIX: Path traversal in request_uri variable</a></li><li><a href=https://xvnpw.github.io/posts/path_traversal_in_authorization_context_in_traefik_and_haproxy/>Path traversal in authorization context in Traefik and HAProxy</a></li><li><a href=https://xvnpw.github.io/posts/path_traversal_in_authorization_context_in_kong_and_f5_nginx/>Path traversal in authorization context in Kong and F5 NGINX</a></li><li><a href=https://xvnpw.github.io/posts/bug_bounty_tips_for_nginx_request_uri_path_traversal_bypass/>Bug bounty tips for nginx $request_uri path traversal bypass</a></li><li><a href=https://xvnpw.github.io/posts/hunting_for_buggy_authentication_authorization_services_on_github/>Hunting for buggy authentication/authorization services on github</a></li></ul><hr><p>Thanks for reading! You can follow me on <a href=https://twitter.com/xvnpw>Twitter</a>.</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/kubernetes>kubernetes</a></li><li><a href=/tags/ingress>ingress</a></li><li><a href=/tags/emissary>emissary</a></li><li><a href=/tags/path-traversal>path-traversal</a></li></ul></nav></div></article></main><footer><hr><a class=soc href=https://github.com/xvnpw title=GitHub><i data-feather=github></i></a>|<a class=soc href=https://twitter.com/xvnpw title=Twitter><i data-feather=twitter></i></a>|‚ö°Ô∏è
2022 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></footer><script>feather.replace()</script></div></body></html>