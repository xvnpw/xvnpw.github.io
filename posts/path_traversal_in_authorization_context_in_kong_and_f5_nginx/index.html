<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Path traversal in authorization context in Kong and F5 NGINX - xvnpw personal blog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="In this part I will research another ingress controller based on nginx: ü¶ç kong. At the end of article I will mention in short F5 NGINX Ingress Controller. In kong there is no explicit feature called external authentication, but developers gave possibility to create it using plugins."><meta property="og:image" content><meta property="og:title" content="Path traversal in authorization context in Kong and F5 NGINX"><meta property="og:description" content="In this part I will research another ingress controller based on nginx: ü¶ç kong. At the end of article I will mention in short F5 NGINX Ingress Controller. In kong there is no explicit feature called external authentication, but developers gave possibility to create it using plugins."><meta property="og:type" content="article"><meta property="og:url" content="https://xvnpw.github.io/posts/path_traversal_in_authorization_context_in_kong_and_f5_nginx/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-11-25T20:49:02+01:00"><meta property="article:modified_time" content="2021-11-25T20:49:02+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Path traversal in authorization context in Kong and F5 NGINX"><meta name=twitter:description content="In this part I will research another ingress controller based on nginx: ü¶ç kong. At the end of article I will mention in short F5 NGINX Ingress Controller. In kong there is no explicit feature called external authentication, but developers gave possibility to create it using plugins."><script src=https://xvnpw.github.iojs/feather.min.js></script>
<link href=https://xvnpw.github.io/css/fonts.b685ac6f654695232de7b82a9143a46f9e049c8e3af3a21d9737b01f4be211d1.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://xvnpw.github.io/css/main.40ca3a860425083862b7ebd55447caec5c4384573f0cb098b8d06a91e8dace2e.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://xvnpw.github.io/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css media="(prefers-color-scheme: dark)"><link rel=stylesheet type=text/css href=https://xvnpw.github.io/css/my.6c05193fd59255e7809f44153be743523b36838b781ff558a2ca5c9ce14a756e.css></head><body><div class=content><header><div class=main><a href=https://xvnpw.github.io>xvnpw personal blog</a></div><nav><a href=/>Home</a>
<a href=/posts>All posts</a>
<a href=/about>About</a>
<a href=/tags>Tags</a></nav></header><main><article><div class=title><h1 class=title>Path traversal in authorization context in Kong and F5 NGINX</h1><div class=meta>Posted on Nov 25, 2021</div></div><section class=body><figure class=image-center><img src=https://user-images.githubusercontent.com/17719543/139592951-0fafc921-437e-4bb7-b0ee-199dd72b36c3.png></figure><p>In this part I will research another ingress controller based on <strong>nginx</strong>: ü¶ç <a href=https://konghq.com/solutions/kubernetes-ingress/>kong</a>. At the end of article I will mention in short <a href=https://www.nginx.com/products/nginx-ingress-controller>F5 NGINX Ingress Controller</a>.</p><p>In kong there is no explicit feature called external authentication, but developers gave possibility to create it using plugins.</p><p>Here are some links describing this process:</p><ul><li><a href=https://konghq.com/blog/custom-authentication-and-authorization-framework-with-kong/>Custom Authentication and Authorization Framework with Kong</a></li><li><a href=https://github.com/aunkenlabs/kong-external-auth>aunkenlabs/kong-external-auth</a> - repository with PoC of external-auth. It&rsquo;s old and cannot be run as it with kong 2.6, which is latest at time of writing.</li></ul><p>During analysis I have found two possible exploitation paths:</p><ul><li>using <a href=https://docs.konghq.com/hub/kong-inc/basic-auth/>basic-auth</a> and <a href=https://docs.konghq.com/hub/kong-inc/acl/>acl plugins</a> - general idea is to create acl for route to protect service. I have tested it but, was not able to exploit üôÅ</li><li>using custom plugin to implement external authentication</li></ul><h2 id=custom-plugin>Custom Plugin</h2><p>I based my plugin on <code>aunkenlabs/kong-external-auth</code>, but made it compatible with kong 2.6 and align with my <code>auth-service</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> BasePlugin <span style=color:#f92672>=</span> require <span style=color:#e6db74>&#34;kong.plugins.base_plugin&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> http <span style=color:#f92672>=</span> require <span style=color:#e6db74>&#34;resty.http&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> ExternalAuthHandler <span style=color:#f92672>=</span> BasePlugin:extend()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>ExternalAuthHandler</span>:<span style=color:#a6e22e>new</span>()
</span></span><span style=display:flex><span>  ExternalAuthHandler.super.new(self, <span style=color:#e6db74>&#34;external-auth&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>ExternalAuthHandler</span>:<span style=color:#a6e22e>access</span>(conf)
</span></span><span style=display:flex><span>  ExternalAuthHandler.super.access(self)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>local</span> client <span style=color:#f92672>=</span> http.new()
</span></span><span style=display:flex><span>  client:set_timeouts(conf.connect_timeout, send_timeout, read_timeout)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>local</span> res, err <span style=color:#f92672>=</span> client:request_uri(conf.url, {
</span></span><span style=display:flex><span>    method <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span>    ssl_verify <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>    headers <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      [<span style=color:#e6db74>&#34;X-Original-Uri&#34;</span>] <span style=color:#f92672>=</span> ngx.var.request_uri,
</span></span><span style=display:flex><span>      [<span style=color:#e6db74>&#34;X-Forwarded-Path&#34;</span>] <span style=color:#f92672>=</span> kong.request.get_path(),
</span></span><span style=display:flex><span>      [<span style=color:#e6db74>&#34;X-Forwarded-Method&#34;</span>] <span style=color:#f92672>=</span> kong.request.get_method(),
</span></span><span style=display:flex><span>      [<span style=color:#e6db74>&#34;X-Forwarded-Query&#34;</span>] <span style=color:#f92672>=</span> kong.request.get_raw_query(),
</span></span><span style=display:flex><span>      [<span style=color:#e6db74>&#34;X-Api-Key&#34;</span>] <span style=color:#f92672>=</span> kong.request.get_headers()[<span style=color:#e6db74>&#34;X-Api-Key&#34;</span>]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> res <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> kong.response.exit(<span style=color:#ae81ff>500</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> res.status <span style=color:#f92672>~=</span> <span style=color:#ae81ff>200</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> kong.response.exit(<span style=color:#ae81ff>401</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ExternalAuthHandler.PRIORITY <span style=color:#f92672>=</span> <span style=color:#ae81ff>900</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> ExternalAuthHandler
</span></span></code></pre></div><p>To load this plugin in Kubernetes deployment, read this guide: <a href=https://docs.konghq.com/kubernetes-ingress-controller/2.0.x/guides/setting-up-custom-plugins/>setting up custom plugins</a>. I loaded it as <code>ConfigMap</code> and added reference to <code>values.yaml</code>.</p><h2 id=test>Test</h2><p>I&rsquo;m using kong in version <strong>2.6.0</strong> and kong ingress in <strong>2.0.5</strong>.</p><p>This what is most important is value of headers that are coming into <code>auth-service</code>.</p><p>First payload: <code>curl --path-as-is -v http://app.test/public-service/../protected-service/protected</code>:</p><figure><img src=https://user-images.githubusercontent.com/17719543/140642782-6f764efb-af14-433c-9a91-e90624adeacd.png></figure><p>and logs from <code>auth-service</code>:</p><figure><img src=https://user-images.githubusercontent.com/17719543/140642764-128d25d7-a5fd-40c2-8982-cc0f4ae77d86.png></figure><p>As you can see from image values of both headers are manipulated:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>X-Original-Uri: /public-service/../protected-service/protected
</span></span><span style=display:flex><span>X-Forwarded-Path: /public-service/../protected-service/protected
</span></span></code></pre></div><p>Why both headers are important? So first header is taken directly from <code>ngx.var.request_uri</code> but second one is taken using kong api: <code>kong.request.get_path()</code>. Result is a bit shocking for me as I was expecting to see normalized path in case of call to kong api. This is due fact that in kong <a href=https://github.com/Kong/kong/blob/f27c5868fc48bec1cc9e740bd1d1cf65793c473d/kong/tools/uri.lua#L60>source code</a> there is path normalization implemented.</p><p>In case of second payload: <code>curl -v http://app.test/public-service/..%2Fprotected-service/protected</code>. There is <strong>no success</strong>:</p><figure><img src=https://user-images.githubusercontent.com/17719543/140642947-3e2302d0-5668-48f8-b318-c503f937fab6.png></figure><p>It&rsquo;s interesting that kong is not url decoding <code>%2F</code>. What is even more interesting it&rsquo;s decoding <code>%2E</code> to <code>.</code> ü§î</p><p>The <code>404</code> is coming from <code>public-service</code>:</p><figure><img src=https://user-images.githubusercontent.com/17719543/140642967-98e2d374-9b82-4a69-95ed-3074ed39e042.png></figure><h2 id=f5-nginx-ingress-controller>F5 NGINX Ingress Controller</h2><p>There is no dedicated feature for external authentication, but using annotations you can add it like this (<a href=https://github.com/nginxinc/kubernetes-ingress/issues/873>read more</a>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>extensions/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Ingress</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>nginx.org/location-snippets</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      </span>      <span style=color:#ae81ff>auth_request /auth;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>nginx.org/server-snippets</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      location = /auth {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        return 200;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      }</span>      
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>cafe-ingress</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span></code></pre></div><p>If you can add external auth, you can also add <code>$request_uri</code> as some header, which will effectively allow exploitation using path traversal.</p><h2 id=summary>Summary</h2><p>After failed on exploitation with ingresses based on Traefik and envoy, I had mixed feelings about kong. This time I was successful üòÄ. From defenders perspective it&rsquo;s good that <code>acl</code> plugin is not vulnerable. In external auth case, developers need to build custom plugin and authentication service without path normalization.</p><p>Kong developers are very explicit about <code>get_path()</code> function. In documentation there is info that it&rsquo;s not normalized in anyway. This is clear indicator for creators of custom plugins: <a href=https://docs.konghq.com/gateway/2.6.x/pdk/kong.request/#kongrequestget_path>https://docs.konghq.com/gateway/2.6.x/pdk/kong.request/#kongrequestget_path</a>. I have also check code of various kong plugins and they are secure. <strong>So the only valid case for exploitation is custom plugin using not normalized variables</strong>.</p><p>Here my code if you want to try yourself: <a href=https://github.com/xvnpw/k8s-ingress-auth-bypass-kong>https://github.com/xvnpw/k8s-ingress-auth-bypass-kong</a></p><p><strong>F5 NGINX Ingress Controller</strong> is also suffering from <code>request_uri</code> being not normalized.</p><h3 id=other-articles-from-this-series>Other articles from this series</h3><ul><li><a href=https://xvnpw.github.io/posts/cve_2021_43557_apache_apisix_path_traversal_in_request_uri_variable/>CVE-2021-43557: Apache APISIX: Path traversal in request_uri variable</a></li><li><a href=https://xvnpw.github.io/posts/path_traversal_in_authorization_context_in_traefik_and_haproxy/>Path traversal in authorization context in Traefik and HAProxy</a></li><li><a href=https://xvnpw.github.io/posts/path_traversal_in_authorization_context_in_emissary/>Path traversal in authorization context in Emissary</a></li><li><a href=https://xvnpw.github.io/posts/bug_bounty_tips_for_nginx_request_uri_path_traversal_bypass/>Bug bounty tips for nginx $request_uri path traversal bypass</a></li><li><a href=https://xvnpw.github.io/posts/hunting_for_buggy_authentication_authorization_services_on_github/>Hunting for buggy authentication/authorization services on github</a></li></ul><hr><p>Thanks for reading! You can follow me on <a href=https://twitter.com/xvnpw>Twitter</a>.</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/kubernetes>kubernetes</a></li><li><a href=/tags/ingress>ingress</a></li><li><a href=/tags/kong>kong</a></li><li><a href=/tags/path-traversal>path-traversal</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/xvnpw title=GitHub><i data-feather=github></i></a><a class=soc href=https://twitter.com/xvnpw title=Twitter><i data-feather=twitter></i></a></div><div class=footer-info>2022 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script>feather.replace()</script></div></body></html>