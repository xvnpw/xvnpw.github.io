<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Mitigating SSRF vulnerabilities in Go. A practical guide. Part 1 - xvnpw personal blog</title><link rel=icon type=image/png href=/favicon.png><meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Server-Side Request Forgery (SSRF) vulnerabilities have been around for a long time, and they still pose a significant threat to web applications, so much so this kind of vulnerability has been included in OWASP TOP 10. This time I will explain how to mitigate SSRF vulnerability in Go applications."><meta property="og:image" content><meta property="og:url" content="https://xvnpw.github.io/posts/mitigating_ssrf_vulnerabilities_in_go_a_practical_guide_part_1/"><meta property="og:site_name" content="xvnpw personal blog"><meta property="og:title" content="Mitigating SSRF vulnerabilities in Go. A practical guide. Part 1"><meta property="og:description" content="Server-Side Request Forgery (SSRF) vulnerabilities have been around for a long time, and they still pose a significant threat to web applications, so much so this kind of vulnerability has been included in OWASP TOP 10. This time I will explain how to mitigate SSRF vulnerability in Go applications."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-07-29T18:59:02+01:00"><meta property="article:modified_time" content="2023-07-29T18:59:02+01:00"><meta property="article:tag" content="Appsec"><meta property="article:tag" content="Go"><meta property="article:tag" content="Ssrf"><meta name=twitter:card content="summary"><meta name=twitter:title content="Mitigating SSRF vulnerabilities in Go. A practical guide. Part 1"><meta name=twitter:description content="Server-Side Request Forgery (SSRF) vulnerabilities have been around for a long time, and they still pose a significant threat to web applications, so much so this kind of vulnerability has been included in OWASP TOP 10. This time I will explain how to mitigate SSRF vulnerability in Go applications."><script src=https://xvnpw.github.io/js/feather.min.js></script><link href=https://xvnpw.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://xvnpw.github.io/css/main.5cebd7d4fb2b97856af8d32a6def16164fcf7d844e98e236fcb3559655020373.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://xvnpw.github.io/css/dark.d22e2a2879d933a4b781535fc4c4c716e9f9d35ea4986dd0cbabda82effc4bdd.css media="(prefers-color-scheme: dark)"><link rel=stylesheet type=text/css href=https://xvnpw.github.io/css/my.6e08ae20ebbcf10b8953bc0c3935a825ae172c99096f9af1bf2df91a6d21a1be.css></head><body><div class=content><header><div class=main><a href=https://xvnpw.github.io/>xvnpw personal blog</a></div><nav><a href=/>Home</a>
<a href=/posts>All posts</a>
<a href=/about>About</a>
<a href=/tags>Tags</a></nav></header><main><article><div class=title><h1 class=title>Mitigating SSRF vulnerabilities in Go. A practical guide. Part 1</h1><div class=meta>Posted on Jul 29, 2023</div></div><section class=body><p>Server-Side Request Forgery (SSRF) vulnerabilities have been around for a long time, and they still pose a significant threat to web applications, so much so this kind of vulnerability has been included in OWASP TOP 10. This type of attack allows an attacker to send unauthorized requests from a vulnerable application, which can lead to data leakage, server-side request smuggling, and even full-scale remote code execution.</p><h2 id=basic-example-of-ssrf-in-go>Basic example of SSRF in Go</h2><p>Let&rsquo;s see basic code that introduce this vulnerability:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/debug&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>context</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>urlFromUser</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Query</span>(<span style=color:#e6db74>&#34;url&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// no validation yloo</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>urlFromUser</span>)
</span></span></code></pre></div><p>It&rsquo;s very simple:</p><ul><li>in line 1 we defined <code>/debug</code> endpoint</li><li>in line 2 we got input from user</li><li>in line 4 we issue request totally forgetting about any security concerns ðŸ˜‡</li></ul><p>Before going deeper let&rsquo;s check <a href=https://owasp.org/www-project-top-ten/>OWASP TOP 10</a>.</p><h2 id=owasp-top-10>OWASP Top 10</h2><p>If you don&rsquo;t know what OWASP Top 10 is I recommend you to visit their page.</p><p>SSRF is number 10 on the 2021 version of the list. It was voted by people together with &ldquo;Security Logging and Monitoring Failures&rdquo;.</p><blockquote><p>SSRF flaws occur whenever a web application is fetching a remote resource without validating the user-supplied URL.</p></blockquote><h2 id=setting-the-stage>Setting the stage</h2><figure class=image-center><img src=https://github.com/xvnpw/xvnpw.github.io/assets/17719543/bc85bf4c-bb95-48e4-a22d-dcaf52473664></figure><p>To have more meaningful example, I will use Kubernetes as my deployment platform. This way I will be able to easily model new services and connections among them.</p><ul><li>attacker will be placed outside of the Kubernetes cluster</li><li>from outside, we can only access Public API. We cannot access Backend API, because it&rsquo;s not exposed</li></ul><p><strong>Attacker objective</strong> is to access Backend API using SSRF flaw in Public API. Our objective is to mitigate that ðŸ˜ˆ</p><h2 id=exploit-1>Exploit 1</h2><p>Let&rsquo;s check first exploit:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    http://publicapi/debug<span style=color:#ae81ff>\?</span>url<span style=color:#ae81ff>\=</span>
</span></span><span style=display:flex><span>        http://backendapi/internal
</span></span><span style=display:flex><span>This is internal sensitive endpoint
</span></span></code></pre></div><ul><li>we sent <code>GET</code> request to <code>publicapi</code> <code>/debug</code> endpoint</li><li>we set <code>url</code> parameter to <code>http://backendapi/internal</code></li><li>and we got response <code>This is internal sensitive endpoint</code></li></ul><p>Each time we will see this response <code>This is internal sensitive endpoint</code> it means that exploit is <strong>successful</strong>.</p><p>To remind how service code look liked:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/debug&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>context</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>urlFromUser</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Query</span>(<span style=color:#e6db74>&#34;url&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// no validation yloo</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>urlFromUser</span>)
</span></span></code></pre></div><p>Without any restrictions, we let attacker to access Backend API ðŸ˜Ÿ</p><h2 id=mitigation>Mitigation</h2><h3 id=code-checker>Code checker</h3><p>Code checker or SAST (Static application security testing) tool, can help us find this problem early and not introduce it at all.</p><p>Let&rsquo;s use <a href=https://github.com/securego/gosec>gosec</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gosec publicapi/
</span></span><span style=display:flex><span>G107 <span style=color:#f92672>(</span>CWE-88<span style=color:#f92672>)</span>: Potential HTTP request made with variable url 
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>Confidence: MEDIUM, Severity: MEDIUM<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    83: urlFromUser :<span style=color:#f92672>=</span> context.Query<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;url&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    &gt; 84: resp, err :<span style=color:#f92672>=</span> http.Get<span style=color:#f92672>(</span>urlFromUser<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>We got exactly line number and brief explanation.</p><p>Other tool that I can recommend for <code>go</code> apps is <a href=https://semgrep.dev/docs/getting-started/>semgrep</a>.</p><h3 id=fix-with-negative-validation>Fix with negative validation</h3><p>We can try to fix this SSRF by validating user input. Validation can be done in many ways. I will try first something that might not be very wise, just to prove a point:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>validateTargetUrl</span>(<span style=color:#a6e22e>input</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>u</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>ParseRequestURI</span>(<span style=color:#a6e22e>input</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Scheme</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;http&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Scheme</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;https&#34;</span>) <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>            (<span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Hostname</span>() <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;backendapi&#34;</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>What this function does is:</p><ul><li>parse <code>input</code> to url</li><li>check if <code>Scheme</code> is <code>http</code> or <code>https</code> and</li><li>make sure that we are not trying to connect to <code>backendapi</code></li></ul><p>Remember, we don&rsquo;t want to let the attacker connect to the <code>backendapi</code>!</p><h3 id=exploit-2>Exploit 2</h3><p>Let&rsquo;s see Public API code one more time. But now, slightly modified:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/debug&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>context</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>urlFromUser</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Query</span>(<span style=color:#e6db74>&#34;url&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// validation because world is full of mean people :(</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>validateTargetUrl</span>(<span style=color:#a6e22e>urlFromUser</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>, <span style=color:#e6db74>&#34;Bad url&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>urlFromUser</span>)
</span></span></code></pre></div><p>and the exploit:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    http://publicapi/debug<span style=color:#ae81ff>\?</span>url<span style=color:#ae81ff>\=</span>
</span></span><span style=display:flex><span>        http://10.96.155.247/internal
</span></span><span style=display:flex><span>This is internal sensitive endpoint
</span></span></code></pre></div><p>Heh, yes, we have successful exploit.</p><p>Why usage of raw IP address was possible? Public API and Backend API are <strong>sharing same network</strong> (Kubernetes!). There is nothing in between.</p><p>Using IP addresses in numerous formats is interesting technique for bypassing SSRF filters.</p><figure class=image-center><img src=https://github.com/xvnpw/xvnpw.github.io/assets/17719543/56b159db-94e1-4478-90e7-3f1883daea1b></figure><p>As you see from above picture there are many ways to represent <code>127.0.0.1</code>, but there is one missing. Very interesting one.</p><p>You can create dns A record for localhost, e.g. <code>xvnpw.localtest.me</code>. Try it yourself!</p><p><strong>Important learning</strong>: negative validation is doomed to failure ðŸ’€</p><h3 id=fix-with-positive-validation>Fix with positive validation</h3><p>We know what was bad last time, let&rsquo;s do better:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>validateTargetUrl</span>(<span style=color:#a6e22e>input</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>u</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>ParseRequestURI</span>(<span style=color:#a6e22e>input</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Scheme</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;http&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Scheme</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;https&#34;</span>) <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>            (<span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Hostname</span>() <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;imageapi&#34;</span>) <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>            (<span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Port</span>() <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Port</span>() <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;80&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Port</span>() <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;443&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>What this function does is:</p><ul><li>parse <code>input</code> to url</li><li>check if <code>Scheme</code> is <code>http</code> or <code>https</code> and</li><li>check if <code>Port</code> is empty, 80 or 443</li><li><strong>check if</strong> <code>Hostname</code> is <code>imageapi</code></li></ul><p>Pretty robust. But what is this Image API? Let&rsquo;s check our new setup:</p><figure class=image-center><img src=https://github.com/xvnpw/xvnpw.github.io/assets/17719543/28c17d0d-ff77-4674-bc27-3aba259bb8e5></figure><p>This time we added Image API to the picture. And in contrast to Backend API, it can be called from Public API <code>/debug</code> endpoint.</p><h3 id=exploit-3>Exploit 3</h3><p>Public API code stays the same:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/debug&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>context</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>urlFromUser</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Query</span>(<span style=color:#e6db74>&#34;url&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// validation because world is full of mean people :(</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>validateTargetUrl</span>(<span style=color:#a6e22e>urlFromUser</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>, <span style=color:#e6db74>&#34;Bad url&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>urlFromUser</span>)
</span></span></code></pre></div><p>and new exploit:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    http://publicapi/debug<span style=color:#ae81ff>\?</span>url<span style=color:#ae81ff>\=</span>
</span></span><span style=display:flex><span>        http://imageapi/redirect<span style=color:#ae81ff>\?</span>target<span style=color:#ae81ff>\=</span>
</span></span><span style=display:flex><span>            http://backendapi/internal
</span></span><span style=display:flex><span>This is internal sensitive endpoint
</span></span></code></pre></div><p>It might seems that it&rsquo;s a bit unfair to abuse Image API, but this is reality in many bug bounty programs. You can find yet another service with vulnerability that you can chain together.</p><p>Do you see what kind of flaw is in Image API? It&rsquo;s <a href=https://portswigger.net/kb/issues/00500100_open-redirection-reflected>Open Redirect</a>. What it does? It returns <code>301</code> redirect http code and <code>Location</code> taken directly from input parameter (<code>target=</code>). It&rsquo;s <code>low</code> vulnerability but can be used to escalate SSRF.</p><h4 id=exploit-3-step-by-step>Exploit 3 step by step</h4><p>Let&rsquo;s dive deeper into this chain of vulnerabilities:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># publicapi</span>
</span></span><span style=display:flex><span>-&gt; /debug request: user-agent<span style=color:#f92672>=</span>curl/7.86.0
</span></span><span style=display:flex><span><span style=color:#ae81ff>200</span> | GET <span style=color:#e6db74>&#34;/debug?url=http://imageapi/redirect?target=
</span></span></span><span style=display:flex><span><span style=color:#e6db74>http://backendapi/internal&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># imageapi</span>
</span></span><span style=display:flex><span>-&gt; /redirect request: user-agent<span style=color:#f92672>=</span>Go-http-client/1.1
</span></span><span style=display:flex><span><span style=color:#ae81ff>301</span> | GET <span style=color:#e6db74>&#34;/redirect?target=http://backendapi/internal&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># backendapi</span>
</span></span><span style=display:flex><span>-&gt; /internal request: user-agent<span style=color:#f92672>=</span>Go-http-client/1.1
</span></span><span style=display:flex><span><span style=color:#ae81ff>200</span> | GET <span style=color:#e6db74>&#34;/internal&#34;</span>
</span></span></code></pre></div><ul><li>first Public API is called on <code>/debug</code> endpoint</li><li>it will validate hostname, which is <code>imageapi</code> - OK!</li><li>than it will call <code>imageapi</code> on <code>/redirect</code> endpoint</li><li>Image API will return <code>301</code> redirect to <code>backendapi</code> location</li><li><strong>Public API will follow redirect and call Backend API</strong></li></ul><p>One more view on this:</p><figure class=image-center><img src=https://github.com/xvnpw/xvnpw.github.io/assets/17719543/b06b7a27-2704-40e1-bb7c-c519b34c6e40></figure><p>This is very interesting. Go <code>http</code> default client will follow any redirects. You will get same behavior in other languages.</p><p>Our positive validation code is best what we could done. Why we didn&rsquo;t mitigate this scenario ðŸ˜Ÿ? It&rsquo;s really simple: <code>http</code> client knows nothing about validation.</p><figure class=image-center><img src=https://github.com/xvnpw/xvnpw.github.io/assets/17719543/6217f5b9-59c0-4ce0-a827-ba1325b8a43f></figure><h2 id=summary>Summary</h2><p>So far attacker <strong>won</strong> this battle, we were not able to protect Backed API service. Positive validation is not enough in case of redirect. We need to take it one step further. I will show you how to do it in part 2 ðŸ˜ƒ</p><h2 id=code>Code</h2><p>You can try yourself with code that is ready to run on your local: <a href=https://github.com/xvnpw/ssrf-in-go>https://github.com/xvnpw/ssrf-in-go</a></p><p>If you have any comments or feedback, you are welcome to write to me on <a href=https://twitter.com/xvnpw>Twitter</a>.</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/appsec>appsec</a></li><li><a href=/tags/go>go</a></li><li><a href=/tags/ssrf>ssrf</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/xvnpw rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/xvnpw rel=me title=Twitter><i data-feather=twitter></i></a>
<a class=border></a><a class=soc href=https://www.linkedin.com/in/marcin-niemiec-304349104/ rel=me title=Linkedin><i data-feather=linkedin></i></a>
<a class=border></a></div><div class=footer-info>2025 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script async src="https://www.googletagmanager.com/gtag/js?id=G-YHETMXZXMZ"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YHETMXZXMZ")}</script><script>feather.replace()</script></div></body></html>