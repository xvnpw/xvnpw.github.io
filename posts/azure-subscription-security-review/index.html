<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Azure subscription securityÂ review - xvnpw personal blog</title><link rel=icon type=image/png href=/favicon.png><meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Lately I have come across task to perform security review of Azure subscription. It was white-box based and I had access to all terraform, Kubernetes and Docker files. I will share with you what checks are worth to do for such review."><meta property="og:image" content><meta property="og:url" content="https://xvnpw.github.io/posts/azure-subscription-security-review/"><meta property="og:site_name" content="xvnpw personal blog"><meta property="og:title" content="Azure subscription securityÂ review"><meta property="og:description" content="Lately I have come across task to perform security review of Azure subscription. It was white-box based and I had access to all terraform, Kubernetes and Docker files. I will share with you what checks are worth to do for such review."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-02-01T10:14:47+01:00"><meta property="article:modified_time" content="2021-02-01T10:14:47+01:00"><meta property="article:tag" content="Azure"><meta property="article:tag" content="Devops"><meta property="article:tag" content="Appsec"><meta name=twitter:card content="summary"><meta name=twitter:title content="Azure subscription securityÂ review"><meta name=twitter:description content="Lately I have come across task to perform security review of Azure subscription. It was white-box based and I had access to all terraform, Kubernetes and Docker files. I will share with you what checks are worth to do for such review."><script src=https://xvnpw.github.io/js/feather.min.js></script><link href=https://xvnpw.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://xvnpw.github.io/css/main.5cebd7d4fb2b97856af8d32a6def16164fcf7d844e98e236fcb3559655020373.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://xvnpw.github.io/css/dark.d22e2a2879d933a4b781535fc4c4c716e9f9d35ea4986dd0cbabda82effc4bdd.css media="(prefers-color-scheme: dark)"><link rel=stylesheet type=text/css href=https://xvnpw.github.io/css/my.0b83e2a92adf566deab02a012390927b24d79d5dc5a21a839eb61419dc041acc.css></head><body><div class=content><header><div class=main><a href=https://xvnpw.github.io/>xvnpw personal blog</a></div><nav><a href=/>Home</a>
<a href=/posts>All posts</a>
<a href=/about>About</a>
<a href=/tags>Tags</a></nav></header><main><article><div class=title><h1 class=title>Azure subscription securityÂ review</h1><div class=meta>Posted on Feb 1, 2021</div></div><section class=body><p>{{ template &ldquo;_internal/google_analytics.html&rdquo; . }}</p><p>Lately I have come across task to perform security review of Azure subscription. It was white-box based and I had access to all terraform, Kubernetes and Docker files. I will share with you what checks are worth to do for such review.</p><figure class=center><img src=https://user-images.githubusercontent.com/17719543/139584399-d5004590-c179-4a87-8c21-aa364f53e293.png></figure><h2 id=my-methodology>My methodology</h2><p>Number of resources to check may vary from project to project. For me best approach is to mix automated tools with manual work. If it&rsquo;s possible I&rsquo;m using two tools for same purpose. It makes my life easier as I don&rsquo;t need to choose best tool ðŸ™‚ It&rsquo;s also improving results.</p><p>I categorize findings into groups:</p><ul><li>Criticalâ€Š-â€Šneed to contact team and fix immediately</li><li>Highâ€Š-â€Šneed to be fixed by team</li><li>Mediumâ€Š-â€Šnice to be fixed</li><li>Lowâ€Š-â€Šleast important to fix</li></ul><h3 id=0Âº-scope-definition>0Âº Scope definition</h3><p>Before starting any actual work, we need to define scope. In many cases it will directly come from team that created resources in Azure. In that case schedule meeting with them and note all important information:</p><ul><li>what is name of Azure subscription to test (you don&rsquo;t want to review wrong one!)</li><li>what is usage of subscription: e.g. production environment for web applicationÂ ?</li><li>link to repository with terraform/Kubernetes/Docker files</li><li>any diagrams reflecting how components are communicating, e.g. UML component diagram or network schema</li><li>ask team to go briefly with Azure resources descriptionâ€Š-â€Šno need to be detailed at this point</li><li>what is team priority for reviewâ€Š-â€Šthis is quite important question. On one hand it shows expectations from team, but also can potentially reveal strong and weak sides of configuration.</li><li>establish with team way to contact during review. This time you can give some your expectations, e.g. do status meetings daily and contact immediately on critical findings.</li></ul><h3 id=1Âº-turn-on-azuredefender>1Âº Turn on AzureÂ Defender</h3><p>Now it&rsquo;s finally time to go into Azure portal.</p><p>At beginning my first steps are into Security Center to turn on paid version of it (currently named Azure Defender). This will do additional scanning and give results of regulatory compliance, e.g. ISO 27001, PCI DSS. Generally speaking this paid version <strong>should be turned on already</strong> at this point as it&rsquo;s giving a lot into cloud security.</p><p>Security Center is based in some part on logs coming from agents, so let&rsquo;s give it some time to run.</p><h3 id=2Âº-manualcheck>2Âº ManualÂ check</h3><p>Having head full of knowledge from scope definition it&rsquo;s time to get familiar with target subscription. This step is based more on intuition than strictly technical. Try to go from resource to resource checking network and security configuration. If something is having &ldquo;bad smell&rdquo; just follow it to clarify for 100% whether is good or not. Typically I look for:</p><ul><li>open Storage Accounts</li><li>open ports in Network Security Groups (NSGs)</li><li>not protected Virtual Machines</li><li>misconfiguration in deployed services: databases, Elasticsearch, Redis, etc.</li><li>wrong or to permissive RBAC roles assignment</li></ul><h3 id=3Âº-terraform-filescheck>3Âº Terraform filesÂ check</h3><p>If you are lucky and team is using Infrastructure as a Code, you can test it with automated tools. There are good in finding typical misconfiguration. For terraform I&rsquo;m using two:</p><ul><li><a href=https://github.com/bridgecrewio/checkov>https://github.com/bridgecrewio/checkov</a></li><li><a href=https://github.com/tfsec/tfsec>https://github.com/tfsec/tfsec</a></li></ul><h3 id=4Âº-kubernetes-deployments-check>4Âº Kubernetes deployments check</h3><p>Kubernetes files also can be checked with automated tools. The other way is to check configuration by deploying audit application into cluster. It has benefits as it constantly reporting. It can be running after audit to make team aware about problems.</p><p>In my case, I was checking Helm scripts. If you don&rsquo;t know Helm, it&rsquo;s templating language for Kubernetes. In order to check template I needed first to generate Kubernetes files based on template and values. For most simple case you need to run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm template reviewÂ ./ &gt; output.yaml
</span></span></code></pre></div><p>I have choose checkov to test Kubernetes files:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>checkov --quiet -f output.yaml &gt; checkov.result.txt
</span></span></code></pre></div><p>Second tool that I recommending is kube-scan deployed into cluster:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>az login
</span></span><span style=display:flex><span>az aks get-credentials -resource-group myResourceGroup -name myAKSCluster
</span></span><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/octarinesec/kube-scan/master/kube-scan-lb.yaml
</span></span><span style=display:flex><span>kubectl -n kube-scan get service kube-scan-ui
</span></span></code></pre></div><h3 id=5Âº-dockercheck>5Âº DockerÂ check</h3><p>Dockerfiles can have misconfiguration and docker container can have vulnerabilities, e.g. outdated system packages.</p><p>For checking Dockerfiles I used <a href=https://github.com/hadolint/hadolint>https://github.com/hadolint/hadolint</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run --rm -i hadolint/hadolint &lt; Dockerfile
</span></span></code></pre></div><p>and for docker containers <a href=https://github.com/anchore/anchore-engine>https://github.com/anchore/anchore-engine</a>:</p><script src=https://gist.github.com/xvnpw/7e7dda58486e4f661f9b46b51dcbe79c.js></script><h3 id=6Âº-complex-security-audittool>6Âº Complex security auditÂ tool</h3><p>Last step in checking is based on tool that is doing complex whole subscription check based on numerous rules, mostly coming from <a href=https://www.cisecurity.org/benchmark/azure/>CIS Benchmarks</a>.</p><p>The only tool worth mention that I have found is <a href=https://github.com/nccgroup/ScoutSuite>https://github.com/nccgroup/ScoutSuite</a>. It can check not only Azure but also AWS and GCP.</p><p>I had problem in running ScoutSuite on my local machine, so I did run it eventually on Docker. Problem was related to my version of python.</p><script src=https://gist.github.com/xvnpw/ec08c001b41f29a7f1bb199150fdb7f3.js></script><h3 id=7Âº-writing-report-if-not-didyet>7Âº Writing report (if not didÂ yet)</h3><p>Best way to write report is to do it during review. So that you can take screenshots along the way.</p><h2 id=summary>Summary</h2><p>I must say that I&rsquo;m enjoying this kind of tasks in my work ðŸ™‚ There are good tools and in most cases running smoothly. Biggest problems I had in playing with <code>anchor</code> and <code>ScoutSuite</code>.</p><p>Findings? In my case there were some critical one. Sadly team didn&rsquo;t spot right recommendations in Azure Security Center on time. Monitoring those recommendations manually is not easy for development teams. Good thing is that Azure is giving some options for notifications.</p><p>Please share in comments your ideas about Azure review. What tools are good for you?</p><hr><p>Thanks for reading! You can follow me on <a href=https://twitter.com/xvnpw>Twitter</a>.</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/azure>azure</a></li><li><a href=/tags/devops>devops</a></li><li><a href=/tags/appsec>appsec</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/xvnpw rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/xvnpw rel=me title=Twitter><i data-feather=twitter></i></a>
<a class=border></a><a class=soc href=https://www.linkedin.com/in/marcin-niemiec-304349104/ rel=me title=Linkedin><i data-feather=linkedin></i></a>
<a class=border></a></div><div class=footer-info>2024 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script async src="https://www.googletagmanager.com/gtag/js?id=G-YHETMXZXMZ"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YHETMXZXMZ")}</script><script>feather.replace()</script></div></body></html>