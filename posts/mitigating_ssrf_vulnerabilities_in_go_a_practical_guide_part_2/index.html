<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Mitigating SSRF vulnerabilities in Go. A practical guide. Part 2 - xvnpw personal blog</title><link rel=icon type=image/png href=/favicon.png><meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="In this final part of mitigation guide we will explore doyensec/safeurl library for Go."><meta property="og:image" content><meta property="og:url" content="https://xvnpw.github.io/posts/mitigating_ssrf_vulnerabilities_in_go_a_practical_guide_part_2/"><meta property="og:site_name" content="xvnpw personal blog"><meta property="og:title" content="Mitigating SSRF vulnerabilities in Go. A practical guide. Part 2"><meta property="og:description" content="In this final part of mitigation guide we will explore doyensec/safeurl library for Go."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-04T07:59:02+01:00"><meta property="article:modified_time" content="2023-08-04T07:59:02+01:00"><meta property="article:tag" content="Appsec"><meta property="article:tag" content="Go"><meta property="article:tag" content="Ssrf"><meta name=twitter:card content="summary"><meta name=twitter:title content="Mitigating SSRF vulnerabilities in Go. A practical guide. Part 2"><meta name=twitter:description content="In this final part of mitigation guide we will explore doyensec/safeurl library for Go."><script src=https://xvnpw.github.io/js/feather.min.js></script><link href=https://xvnpw.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://xvnpw.github.io/css/main.5cebd7d4fb2b97856af8d32a6def16164fcf7d844e98e236fcb3559655020373.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://xvnpw.github.io/css/dark.d22e2a2879d933a4b781535fc4c4c716e9f9d35ea4986dd0cbabda82effc4bdd.css media="(prefers-color-scheme: dark)"><link rel=stylesheet type=text/css href=https://xvnpw.github.io/css/my.0b83e2a92adf566deab02a012390927b24d79d5dc5a21a839eb61419dc041acc.css></head><body><div class=content><header><div class=main><a href=https://xvnpw.github.io/>xvnpw personal blog</a></div><nav><a href=/>Home</a>
<a href=/posts>All posts</a>
<a href=/about>About</a>
<a href=/tags>Tags</a></nav></header><main><article><div class=title><h1 class=title>Mitigating SSRF vulnerabilities in Go. A practical guide. Part 2</h1><div class=meta>Posted on Aug 4, 2023</div></div><section class=body><p>In this final part of mitigation guide we will explore <a href=https://github.com/doyensec/safeurl>doyensec/safeurl</a> library for Go.</p><h2 id=setting-the-stage>Setting the stage</h2><p>Reminder about our setup:</p><figure class=image-center><img src=https://github.com/xvnpw/xvnpw.github.io/assets/17719543/28c17d0d-ff77-4674-bc27-3aba259bb8e5></figure><h2 id=explot-3>Explot 3</h2><p>We ended up <a href=https://xvnpw.github.io/posts/mitigating_ssrf_vulnerabilities_in_go_a_practical_guide_part_1/#exploit-3>previous part</a> with following Public API code and exploit that works:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/debug&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>context</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>urlFromUser</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Query</span>(<span style=color:#e6db74>&#34;url&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// validation because world is full of mean people :(
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>validateTargetUrl</span>(<span style=color:#a6e22e>urlFromUser</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>, <span style=color:#e6db74>&#34;Bad url&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>urlFromUser</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    http://publicapi/debug<span style=color:#ae81ff>\?</span>url<span style=color:#ae81ff>\=</span>
</span></span><span style=display:flex><span>        http://imageapi/redirect<span style=color:#ae81ff>\?</span>target<span style=color:#ae81ff>\=</span>
</span></span><span style=display:flex><span>            http://backendapi/internal
</span></span><span style=display:flex><span>This is internal sensitive endpoint
</span></span></code></pre></div><h2 id=safeurl>Safeurl</h2><p>What is it?</p><blockquote><p>A Server Side Request Forgery (SSRF) protection library. Made with ðŸ–¤ by Doyensec LLC.</p></blockquote><p>Features:</p><ul><li>Protect against DNS rebinding</li><li>Validation and issuing request done by one library</li></ul><h3 id=fix-with-safeurl>Fix with safeurl</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>config</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>safeurl</span>.<span style=color:#a6e22e>GetConfigBuilder</span>().
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>SetAllowedHosts</span>(<span style=color:#e6db74>&#34;imageapi&#34;</span>).
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Build</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/debug&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>context</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>urlFromUser</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Query</span>(<span style=color:#e6db74>&#34;url&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>safeurl</span>.<span style=color:#a6e22e>Client</span>(<span style=color:#a6e22e>config</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>urlFromUser</span>)
</span></span></code></pre></div><ul><li>in lines 1-3 we defined configuration that will allow only connect to <code>imageapi</code></li><li>in line 4 we defined <code>/debug</code> endpoint</li><li>in line 5 we got input from user</li><li>in line 6 we created http client based on configuration</li><li>in line 7 we issue request proxing it via safeurl</li></ul><h3 id=try-with-exploit-3>Try with exploit 3</h3><p>Let&rsquo;s take our existing explot and try it out with new code featured with safeurl:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    http://publicapi/debug<span style=color:#ae81ff>\?</span>url<span style=color:#ae81ff>\=</span>
</span></span><span style=display:flex><span>      http://imageapi/redirect<span style=color:#ae81ff>\?</span>target<span style=color:#ae81ff>\=</span>
</span></span><span style=display:flex><span>	      http://backendapi/internal
</span></span><span style=display:flex><span>Get <span style=color:#e6db74>&#34;http://imageapi/redirect?target=http://backendapi/
</span></span></span><span style=display:flex><span><span style=color:#e6db74>internal&#34;</span>: dial tcp 10.96.45.24:80: ip: 10.96.45.24 not 
</span></span><span style=display:flex><span>found in allowlist
</span></span></code></pre></div><p>Great! We successfully mitigated SSRF+Open Redirect chain ðŸ˜ƒ</p><h4 id=exploit-3-step-by-step>Exploit 3 step by step</h4><p>Let&rsquo;s dive deeper into this chain of vulnerabilities:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># publicapi</span>
</span></span><span style=display:flex><span>-&gt; /debug request: user-agent<span style=color:#f92672>=</span>curl/7.86.0
</span></span><span style=display:flex><span><span style=color:#ae81ff>400</span> | GET <span style=color:#e6db74>&#34;/debug?url=http://imageapi/redirect?target=
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  http://backendapi/internal&#34;</span>
</span></span><span style=display:flex><span>ip: 10.96.45.24 not found in allowlist
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e># imageapi</span>
</span></span><span style=display:flex><span>-&gt; /redirect request: user-agent<span style=color:#f92672>=</span>Go-http-client/1.1
</span></span><span style=display:flex><span><span style=color:#ae81ff>301</span> | GET <span style=color:#e6db74>&#34;/redirect?target=http://backendapi/internal&#34;</span>
</span></span></code></pre></div><ul><li>first Public API is called on <code>/debug</code> endpoint</li><li>it will validate hostname (using safeurl), which is <code>imageapi</code> - OK!</li><li>than it will call <code>imageapi</code> on <code>/redirect</code> endpoint</li><li>Image API will return <code>301</code> redirect to <code>backendapi</code> location</li><li><strong>Public API will not follow redirect</strong>, because safeurl validated this redirect and it&rsquo;s not in allowlist (imageapi)</li></ul><h2 id=fix-with-redirect-turn-off>Fix with redirect turn off</h2><p>We don&rsquo;t need to use safeurl to mitigate those flaws. We can also turn off redirects in <code>http</code> client:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>DefaultClient</span>.<span style=color:#a6e22e>CheckRedirect</span> =
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>req</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>via</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ErrUseLastResponse</span>
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><h3 id=try-with-exploit-3-1>Try with exploit 3</h3><p>Let&rsquo;s try it with turned off redirects:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    http://publicapi/debug<span style=color:#ae81ff>\?</span>url<span style=color:#ae81ff>\=</span>
</span></span><span style=display:flex><span>      http://imageapi/redirect<span style=color:#ae81ff>\?</span>target<span style=color:#ae81ff>\=</span>
</span></span><span style=display:flex><span>	      http://backendapi/internal
</span></span><span style=display:flex><span>&lt;a href<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://backendapi/internal&#34;</span>&gt;Moved Permanently&lt;/a&gt;.
</span></span></code></pre></div><p>Bit different response, but similar result. Which is better? Safeurl can handle redirects that targets allowlist, but it&rsquo;s additional library to your project. You need to decide.</p><h2 id=safeurl-in-details>Safeurl in details</h2><p>Let&rsquo;s dive deep into safeurl to see how it was implemented:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>buildHttpClient</span>(<span style=color:#a6e22e>wc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>WrappedClient</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Client</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Client</span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CheckRedirect</span>: <span style=color:#a6e22e>wc</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>CheckRedirect</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Transport</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Transport</span>{
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>TLSClientConfig</span>: <span style=color:#a6e22e>wc</span>.<span style=color:#a6e22e>tlsConfig</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>DialContext</span>: (<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>Dialer</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Resolver</span>: <span style=color:#a6e22e>wc</span>.<span style=color:#a6e22e>resolver</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Control</span>:  <span style=color:#a6e22e>buildRunFunc</span>(<span style=color:#a6e22e>wc</span>),
</span></span><span style=display:flex><span>      }).<span style=color:#a6e22e>DialContext</span>,
</span></span></code></pre></div><p>Above function is used to build <code>http</code> client. Safeurl is wrapping that client to control network communication:</p><ul><li>we can see that redirects are controled with config function like this: <code>wc.config.CheckRedirect</code></li><li>most important is <code>DialContext</code> which has <code>Resolver: wc.resolver</code> and <code>Control: buildRunFunc(wc)</code><ul><li>this way we can inspect and control every network call of <code>http</code> client</li></ul></li></ul><p>Remarkable how easy it&rsquo;s in <code>go</code> to wire into low level network call for <code>http</code>. Well done!</p><h2 id=other-controls-for-ssrf-mitigation>Other controls for SSRF mitigation</h2><p>What else we can do to be protected? SSRF mitigation is not only about code but also about architecture:</p><ul><li>all outbound network traffic should go through egress proxy</li><li>internal Kubernetes network should be segmented using Network Policies</li><li>microservice endpoints should require authentication</li></ul><h2 id=real-life-ssrf-attacks>Real life SSRF attacks</h2><p>With this vulnerability attacker can:</p><ul><li>steal cloud metadata credentials (169.254.169.254)</li><li>steal sensitive tokens (attached by service to http call)</li><li>call internal network sensitive resources</li><li>escalate to RCE via 3rd party apps, e.g. redis, Confluence</li></ul><p>Typical places where SSRF can occur:</p><ul><li>webhooks</li><li>file imports from urls</li><li>PDF generators</li></ul><h2 id=summary>Summary</h2><ul><li>if possible not consume full URLs from users (ðŸ˜… webhooks)</li><li>apply application level protection - doyensec/safeurl or custom implementation</li><li>apply zero trust architecture protection - network segmentation and authentication</li></ul><h2 id=code>Code</h2><p>You can try yourself with code that is ready to run on your local: <a href=https://github.com/xvnpw/ssrf-in-go>https://github.com/xvnpw/ssrf-in-go</a></p><p>If you have any comments or feedback, you are welcome to write to me on <a href=https://twitter.com/xvnpw>Twitter</a>.</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/appsec>appsec</a></li><li><a href=/tags/go>go</a></li><li><a href=/tags/ssrf>ssrf</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/xvnpw rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/xvnpw rel=me title=Twitter><i data-feather=twitter></i></a>
<a class=border></a><a class=soc href=https://www.linkedin.com/in/marcin-niemiec-304349104/ rel=me title=Linkedin><i data-feather=linkedin></i></a>
<a class=border></a></div><div class=footer-info>2024 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script async src="https://www.googletagmanager.com/gtag/js?id=G-YHETMXZXMZ"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YHETMXZXMZ")}</script><script>feather.replace()</script></div></body></html>