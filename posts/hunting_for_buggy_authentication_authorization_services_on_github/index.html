<!doctype html><html><head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge"><title>Hunting for buggy authentication/authorization services on github - xvnpw personal blog</title><meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="To successful bypass access control using path traversal in $request_uri, you need to have buggy authentication/authorization service. Buggy in a way it&rsquo;s not normalizing url/uri that is part of access control decision. Let me find more of those on github that are relying on X-Original-Url. There is high chance that this header is populated from $request_uri variable and not protected in any way.
pomerium  Pomerium is an identity-aware proxy that enables secure access to internal applications.">
<meta property="og:image" content>
<meta property="og:title" content="Hunting for buggy authentication/authorization services on github">
<meta property="og:description" content="To successful bypass access control using path traversal in $request_uri, you need to have buggy authentication/authorization service. Buggy in a way it&rsquo;s not normalizing url/uri that is part of access control decision. Let me find more of those on github that are relying on X-Original-Url. There is high chance that this header is populated from $request_uri variable and not protected in any way.
pomerium  Pomerium is an identity-aware proxy that enables secure access to internal applications.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://xvnpw.github.io/posts/hunting_for_buggy_authentication_authorization_services_on_github/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-11-28T10:58:59+01:00">
<meta property="article:modified_time" content="2021-11-28T10:58:59+01:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Hunting for buggy authentication/authorization services on github">
<meta name=twitter:description content="To successful bypass access control using path traversal in $request_uri, you need to have buggy authentication/authorization service. Buggy in a way it&rsquo;s not normalizing url/uri that is part of access control decision. Let me find more of those on github that are relying on X-Original-Url. There is high chance that this header is populated from $request_uri variable and not protected in any way.
pomerium  Pomerium is an identity-aware proxy that enables secure access to internal applications.">
<script src=https://xvnpw.github.io/js/feather.min.js></script>
<link href=https://xvnpw.github.io/css/fonts.b685ac6f654695232de7b82a9143a46f9e049c8e3af3a21d9737b01f4be211d1.css rel=stylesheet>
<link rel=stylesheet type=text/css media=screen href=https://xvnpw.github.io/css/main.2f9b5946627215dc1ae7fa5f82bfc9cfcab000329136befeea5733f21e77d68f.css>
<link id=darkModeStyle rel=stylesheet type=text/css href=https://xvnpw.github.io/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css media="(prefers-color-scheme: dark)">
<link rel=stylesheet type=text/css href=https://xvnpw.github.io/css/my.6c05193fd59255e7809f44153be743523b36838b781ff558a2ca5c9ce14a756e.css>
</head>
<body>
<div class=content><header>
<div class=main>
<a href=https://xvnpw.github.io/>xvnpw personal blog</a>
</div>
<nav>
<a href=/>Home</a>
<a href=/posts>All posts</a>
<a href=/about>About</a>
<a href=/tags>Tags</a>
</nav>
</header>
<main>
<article>
<div class=title>
<h1 class=title>Hunting for buggy authentication/authorization services on github</h1>
<div class=meta>Posted on Nov 28, 2021</div>
</div>
<section class=body>
<figure class=image-center><img src=https://user-images.githubusercontent.com/17719543/139592951-0fafc921-437e-4bb7-b0ee-199dd72b36c3.png>
</figure>
<p>To successful bypass access control using path traversal in <code>$request_uri</code>, you need to have buggy authentication/authorization service. Buggy in a way it&rsquo;s not normalizing url/uri that is part of access control decision. Let me find more of those on github that are relying on <code>X-Original-Url</code>. There is high chance that this header is populated from <code>$request_uri</code> variable and not protected in any way.</p>
<h2 id=pomerium>pomerium</h2>
<blockquote>
<p>Pomerium is an identity-aware proxy that enables secure access to internal applications.</p>
</blockquote>
<p>In research I was using pomerium in version <strong>0.15.5</strong>.</p>
<p>Let&rsquo;s look into code. Here is how <code>X-Original-Url</code> header is used:</p>
<figure><img src=https://user-images.githubusercontent.com/17719543/139598398-f7236d2f-a6a6-4cc3-8d4e-b384a4f702d7.png>
</figure>
<p>Later this <code>originalURL</code> is taking part in decision based on polices. Policy definition can include path, which is key information here:</p>
<figure><img src=https://user-images.githubusercontent.com/17719543/139598428-2a91dfde-897e-47a1-a5ea-b6b73b7f0f4f.png>
</figure>
<p>As you can see there are two possibilities interesting for exploitation: <code>Prefix</code> and <code>Regex</code>.</p>
<p>In official docs you can find how to specify such policy:</p>
<figure><img src=https://user-images.githubusercontent.com/17719543/139598445-2bf29761-e9a4-4738-a5e4-927e716baf60.png>
</figure>
<p>For now I&rsquo;m not going to exploit it further as it quite complicated to setup environment for it. I cannot be 100% sure for successful exploitation, but I have strong indicators in code that it will occur.</p>
<h2 id=authelia>authelia</h2>
<blockquote>
<p>Authelia is an open-source authentication and authorization server providing two-factor authentication and single sign-on (SSO) for your applications via a web portal. It acts as a companion for reverse proxies like nginx, Traefik or HAProxy to let them know whether requests should either be allowed or redirected to Authelia&rsquo;s portal for authentication.</p>
</blockquote>
<p>In research I was using authelia in version <strong>4.32.2</strong>.</p>
<p>The official description of the authelia perfectly matching my exploitation scenario. I just need to have policy based on path and no defense on <code>X-Original-Url</code> header.</p>
<p>Let&rsquo;s check code first:</p>
<figure><img src=https://user-images.githubusercontent.com/17719543/139598518-85f428db-bafc-4bcb-ae49-9b108f2cabd6.png>
</figure>
<p><code>X-Original-Url</code> header is take from request without much of validation and placed later as <code>targetURL</code>:</p>
<figure><img src=https://user-images.githubusercontent.com/17719543/139598541-334a5da0-1dc5-4aea-8eb2-f5459cf23db5.png>
</figure>
<p>After that <code>targetURL</code> is part of logic to make decision whether request is passed as is or required to be authenticated:</p>
<figure><img src=https://user-images.githubusercontent.com/17719543/139598551-7038031f-6d80-450b-adb8-94439b31b35d.png>
</figure>
<p>In official documentation there is example of rule using in resource regex:</p>
<figure><img src=https://user-images.githubusercontent.com/17719543/139598563-4f497082-bd4d-4079-bb18-643631c40178.png>
</figure>
<p>For me, this case is very similar to pomerium. I will also not go deeper for now in exploitation. It&rsquo;s visible for me, that authelia has strong indicator for successful exploitation, but one more time I cannot be 100% sure.</p>
<h2 id=travisghansenexternal-auth-server>travisghansen/external-auth-server</h2>
<p><a href=https://github.com/travisghansen/external-auth-server>travisghansen/external-auth-server</a> has primary function to help Kubernetes users to deal with different authentication schemas. In <a href=https://github.com/travisghansen/external-auth-server/blob/master/PLUGINS.md#request_js>documentation</a> I could find ideal case for bypass. It&rsquo;s using <code>request_js</code> plugin to make decision based on <code>X-Original-Url</code> header:</p>
<figure><img src=https://user-images.githubusercontent.com/17719543/139594490-48b32b0d-0631-49a7-b2c6-0de034871102.png>
</figure>
<p>To be sure, whether any normalization is in place, I have checked code that is making this <code>parentReqInfo</code> object:</p>
<p>It&rsquo;s in <a href=https://github.com/travisghansen/external-auth-server/blob/10ad9710390f38803de92f67e611a568e8d2c79f/src/utils.js#L119>utils.js</a> in function <code>get_parent_request_info</code>:</p>
<figure><img src=https://user-images.githubusercontent.com/17719543/139594519-9c3caaa2-e1d9-4e8a-b9cf-c2f59885ba4e.png>
</figure>
<p>I had some problems to run travisghansen/external-auth-server in Kubernetes. Mostly because it&rsquo;s quite complicated. So to really verify if it&rsquo;s vulnerable, I have copied part of utils.js and tested only it:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#e6db74>&#39;use strict&#39;</span>;

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>express</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;express&#39;</span>);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>utils</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./utils&#39;</span>)

<span style=color:#75715e>// Constants
</span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PORT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>8080</span>;
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>HOST</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;0.0.0.0&#39;</span>;

<span style=color:#75715e>// App
</span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>express</span>();
<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/verify&#39;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>headers</span>);

    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>parentReqInfo</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>utils</span>.<span style=color:#a6e22e>get_parent_request_info</span>(<span style=color:#a6e22e>req</span>);

    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>parentReqInfo</span>);

    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>parentReqInfo</span>.<span style=color:#a6e22e>parsedUri</span>.<span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#39;/public-service/&#39;</span>)) {
        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>statusCode</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>200</span>;
        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>();
    }

    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>apiKey</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>headers</span>[<span style=color:#e6db74>&#39;X-Api-Key&#39;</span>];
    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>apiKey</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;secret-api-key&#34;</span>) {
        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>statusCode</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>200</span>;
        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>();
    }

    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>statusCode</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>401</span>;
    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>();
});

<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#a6e22e>PORT</span>, <span style=color:#a6e22e>HOST</span>);
<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Running on http://</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>HOST</span><span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>PORT</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</code></pre></div><p>First send request using curl:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -v http://app.test/public-service/..%2Fprotected-service/protected
</code></pre></div><p>Next check logs of <code>auth-service</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl logs auth-service-node-859ccc54cc-8cnlp -f
</code></pre></div><figure><img src=https://user-images.githubusercontent.com/17719543/139594574-6c510392-8a2c-4c72-9228-2a7b16627389.png>
</figure>
<p>First <code>{‚Ä¶}</code> is from <code>console.log(req.headers)</code> and second <code>{‚Ä¶} </code>is from <code>console.log(parentReqInfo)</code>. Path is not normalized and wrong decision is made.</p>
<figure><img src=https://user-images.githubusercontent.com/17719543/139594597-49abb40e-7afb-40fb-b4b4-211f871479f0.png>
</figure>
<p>I got protected data. One more time üòÖ</p>
<h2 id=summary>Summary</h2>
<p>I have found three repositories that are using <code>X-Original-Url</code> header and are not protecting against manipulation.</p>
<h3 id=other-articles-from-this-series>Other articles from this series</h3>
<ul>
<li><a href=https://xvnpw.github.io/posts/cve_2021_43557_apache_apisix_path_traversal_in_request_uri_variable/>CVE-2021-43557: Apache APISIX: Path traversal in request_uri variable</a></li>
<li><a href=https://xvnpw.github.io/posts/path_traversal_in_authorization_context_in_traefik_and_haproxy/>Path traversal in authorization context in Traefik and HAProxy</a></li>
<li><a href=https://xvnpw.github.io/posts/path_traversal_in_authorization_context_in_emissary/>Path traversal in authorization context in Emissary</a></li>
<li><a href=https://xvnpw.github.io/posts/path_traversal_in_authorization_context_in_kong_and_f5_nginx/>Path traversal in authorization context in Kong and F5 NGINX</a></li>
<li><a href=https://xvnpw.github.io/posts/bug_bounty_tips_for_nginx_request_uri_path_traversal_bypass/>Bug bounty tips for nginx $request_uri path traversal bypass</a></li>
</ul>
<hr>
<p>Thanks for reading! You can follow me on <a href=https://twitter.com/xvnpw>Twitter</a>.</p>
</section>
<div class=post-tags>
<nav class="nav tags">
<ul class=tags>
<li><a href=/tags/kubernetes>kubernetes</a></li>
<li><a href=/tags/ingress>ingress</a></li>
<li><a href=/tags/nginx>nginx</a></li>
<li><a href=/tags/path-traversal>path-traversal</a></li>
</ul>
</nav>
</div>
</article>
</main>
<footer>
<hr><a class=soc href=https://github.com/xvnpw title=GitHub><i data-feather=github></i></a>|<a class=soc href=https://twitter.com/xvnpw title=Twitter><i data-feather=twitter></i></a>|‚ö°Ô∏è
2021 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a>
</footer>
<script>feather.replace()</script></div>
</body>
</html>